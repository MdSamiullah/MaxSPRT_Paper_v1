% https://who-umc.org/research/data-driven-discovery/
% the RE required to check/find abbreviations
% \b(?:[a-z]*[A-Z][a-z]*){2,} 
% yet to address: SAEFVIC, AESI, LLR, CV, IBM, OO programming

%https://docs.google.com/spreadsheets/d/1JCrWlPveHLAGWnLzogsErOK2XhHBiRfsXtISa3lqxlI/edit#gid=0 : MaxSPRT_paper_example_values

%%%%%%%%%%%%%%%%%%%%%%% file template.tex %%%%%%%%%%%%%%%%%%%%%%%%%
%
% This is a general template file for the LaTeX package SVJour3
% for Springer journals.          Springer Heidelberg 2010/09/16
%
% Copy it to a new file with a new name and use it as the basis
% for your article. Delete % signs as needed.
%
% This template includes a few options for different layouts and
% content for various journals. Please consult a previous issue of 
% your journal as needed.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{fix-cm}
\documentclass[twocolumn]{svjour3}          % twocolumn

\smartqed  % flush right qed marks, e.g. at end of proof

\usepackage{graphicx}%
\usepackage{multirow}%
\usepackage{amsmath,amssymb,amsfonts}%
% \usepackage{amsthm}%
\usepackage{mathrsfs}%
\usepackage[title]{appendix}%
\usepackage[table]{xcolor}%
\usepackage{textcomp}%
\usepackage{manyfoot}%
\usepackage{booktabs}%
\usepackage{algorithmicx}%
\usepackage{algpseudocode}%
\usepackage{listings}%
\usepackage{enumerate}

\usepackage{multirow}
\usepackage{rotating}
\usepackage[export]{adjustbox}
\usepackage{float}
\usepackage[vlined, ruled, linesnumbered]{algorithm2e}
\usepackage{footmisc}
\usepackage{array}
\usepackage{MnSymbol}
\usepackage{latexsym}
\usepackage[inline]{enumitem}
\usepackage{hyperref}
\usepackage{subfigure}
\usepackage{setspace}
\usepackage{tabularx}
\usepackage{mathtools}
\usepackage{balance}
\usepackage{color}
\usepackage{enumerate}
\usepackage{natbib}
\usepackage[normalem]{ulem} % For strikethrough text
\usepackage[utf8]{inputenc}
\usepackage{tikz}

\newtheorem{defi}{Definition}
\newtheorem{ob}{Observation}
\newtheorem{ex}{Example}
\newtheorem{lem}{Lemma}
\newtheorem{prop}{Property}
\newtheorem{thm}{Theorem}
\newtheorem{pf}{Proof}

\usepackage{newunicodechar}
% \newcommand{}{Syringe}

\usepackage{xcolor}
\definecolor{BLUE}{rgb}{0,0,1} % Define BLUE as an alias for standard blue
\definecolor{GREEN}{rgb}{0,1,0} % Define BLUE as an alias for standard blue
\definecolor{RED}{rgb}{1,0,0} % Define BLUE as an alias for standard blue

% \newcommand{\removed}[1]{\textcolor{red}{#1}}
\newcommand{\removed}[1]{\textcolor{red}{\sout{#1}}}
\newcommand{\added}[1]{\textcolor{blue}{#1}}
\newcommand{\changed}[1]{\textcolor{green}{#1}}


\SetKwInOut{Call}{Calling Syntax}

\renewcommand{\qed}{\hfill\blacksquare}

% \LinesNumbered

% \def\BibTeX{{\rm B\kern-.05em{\sc i\kern-.025em b}\kern-.08em
%     T\kern-.1667em\lower.7ex\hbox{E}\kern-.125emX}}

% \usepackage{lastpage}
\usepackage{fancyhdr}
\pagestyle{fancy} 
% \fancyfoot[CO,CE]{\thepage\ / \pageref{LastPage}}

% \pagenumbering{roman}
\pagenumbering{arabic}
%
% \usepackage{mathptmx}      % use Times fonts if available on your TeX system
%
% insert here the call for the packages your document requires
%\usepackage{latexsym}
% etc.
%
% please place your own definitions here and don't use \def but
% \newcommand{}{}
%
% Insert the name of "your journal" with
\journalname{DrugSafety}

% Custom environment for Key Points (optional)

%
\begin{document}\sloppy

% \title{Implementation of MaxSPRT in SAEFVIC settings for Poisson data%\thanks{Grants or other notes
% %about the article that should go on the front page should be
% %placed here. General acknowledgments should be placed at the end of the article.}
% }
\title{\changed{Implementing and Applying Sequential Analysis for Vaccine Safety Surveillance on SAEFVIC Dataset}\removed{Framework for Implementation of Poisson MaxSPRT Technique with Variations for Vaccine Safety}}
% \subtitle{uWspan Mining}

%\titlerunning{Short form of title}        % if too long for running head

% Sami, Jim, Hazel, Jiying, John, Jeremiah, Gonzalo, Ann, Ikee

\author{Md Samiullah      \and
        Jim Buttery       \and
        Hazel J. Clothier    \and
        Jiying Yin   \and
        John Mallard      \and
        Jeremiah Munakabayo        \and
        Gonzalo Sepulveda Kattan            \and
        % Ann E Nicholson            \and
        Gerardo Luis Dimaguila
}

\authorrunning{M Samiullah, J Buttery, H Clothier, J Yin, J Mallard, J Munakabayo, G Kattan, G Demaguila} % if too long for running head

\institute{M Samiullah \and J Buttery \and H Clothier \and J Mallard \and J Munakabayo \and G Kattan \and GL Dimaguila \at
              Murdoch Children's Research Institute \\
              Royal Children's Hospital, 50 Flemington Rd, Parkville, VIC - 3052, Australia\\
              \email{\{md.samiullah, jim.buttery, hazel.clothier, john.mallard, jeremiah.munakabayo, gonzalo.sepulveda, gerardoluis.dimaguil\}@mcri.edu.au}           %  \\
           \and
           J Yin \at
           Australian Financial Security Authority, Australia\\
           \email{Jiying.Yin@afsa.gov.au}
           % \and
           % A Nicholson \at
           % Faculty of Information Technology, Monash University, Wellington Rd, Clayton, VIC-3800, Australia\\
           % \email{ann.nicholson@monash.edu}
}

\date{Received: date / Accepted: date}
% The correct dates will be entered by the editor

\maketitle

\abstract{
For direct, continuous, and sequential drug and vaccine safety surveillance, the Maximized Sequential Probability Ratio Test (MaxSPRT) was developed by \removed{the Centers for Disease Control and Prevention (CDC)}~\citep{kulldorff2011maximized} \changed{Developed by Silva and Kuldorf .... and used by CDC or something. Check read papers... and rewrite and cite properly}. \changed{Its predictive value and power of controlling Type-I and Type-II error as well as achieving optimized Expected Time To Signal (ETS) and Expected Sample Size to signal (ESS), and the ability to monitor adverse events continuously} \added{and in a group manner} have made it an emerging technique for vaccine adverse event surveillance. Moreover, being able to use a statistical method e.g. MaxSPRT in the absence of dose distributed denominator is a practical advantage for spontaneous reporting systems to function as a signal detection system. In this paper, we present a comprehensive \removed{framework} \added{implementation and data wrangling technique in a spontaneous reporting system as a passive continuous surveillance system} \removed{to for applying MaxSPRT for vaccine safety surveillance and Poisson data}. We analysed the literature regarding MaxSPRT and sequential analysis. Our analysis revealed numerous variations of \removed{MaxSPRT} \added{sequential analysis}, adapted to the specific requirements and objectives of the users. Variations are due to differing types of data and purpose of use, including whether used for epidemiological surveillance or for regulatory monitoring, \added{properties and nature of the data, type and attributes of vaccines and the adverse event following immunisation (AEFI)}. This paper provides a comprehensive guide for organisations contemplating the implementation of MaxSPRT \added{as a sequential analysis technique}. It synthesises existing literature on MaxSPRT, identifies variations based on specific requirements, and describes an implementation \added{system specific to poisson data}. We offer a detailed explanation of the steps and challenges associated with the implementation of MaxSPRT on the AEFI  reporting database of Surveillance of Adverse Events Following Vaccination in the Community, Victoria, Australia (SAEFVIC), the largest jurisdictional reporting service by volume in Australia. It also proposes some techniques and measures to deal with the challenges associated with the implementation process.} 

\keywords{Continuous Surveillance, Adverse events, Vaccine pharmacovigilance, Sequential Probability Ratio, Signal detection, reporting delay, real-world datasets}

\section*{\changed{Key Points}}
MaxSPRT is a powerful method for ongoing vaccine surveillance, offering flexibility to adapt to various situations and data limitations. However, this flexibility can lead to challenges in implementation. Our paper simplifies the MaxSPRT method with clear explanations and step-by-step guidance with illustrative computation, addressing potential issues and proposing solutions to improve its use in monitoring vaccine and drug safety.

% MaxSPRT is a powerful vaccine surveillance method with flexibility but implementation challenges. Our paper offers guidance to address these issues and improve vaccine and drug safety monitoring.

\section{Introduction}\label{sec:introduction}

Vaccines keep us safe against harmful diseases by increasing the natural defence of our body and inducing immunity to various infections~\citep{murphy2023trained}. Every licensed vaccine goes through rigorous testing over numerous trial phases before being approved for use by regulators. Nonetheless, adverse events following immunisation could occur, although they are typically modest and transient, like a painful arm or a low-grade fever. Though relatively rare, more severe side effects may occur. Following approval, vaccine safety surveillance services continue to scan and analyse data from a variety of sources for any signs that a vaccine might have unexpected harmful consequences on health, or an increase in incidence or severity of known reactions, known as post-licensure surveillance.

In order to perform post-licensure vaccine safety signal detection, researchers propose diverse approaches that involve various statistical methods, techniques, and measures in original, modified, or combined forms. Research and vaccine surveillance groups may also impose necessary modifications to the approaches during implementation, addressing their organisational strengths and limitations, availability of data, and resources. \added{Note, unlike the works performed so far in the literature, we are targeting a unique aspect of the implementation such as strengths, variations and limitations of data due to organisational factors.}

Key statistical measures and techniques used in post-licensure vaccine surveillance include Proportional Reporting Ratio (PRR)~\citep{clothier2019early}, Cumulative Sum (CUSUM)~\citep{mesfin2021post}, Reporting Odds Ratio (ROR)~\citep{yoon2020updates}, Empirical Bayesian Geometric Mean (EBGM)~\citep{lee2020safety}, Chi-Square, and MaxSPRT~\citep{kulldorff2011maximized}-a specialised variation of Sequential Probability Ratio Test (SPRT)~\citep{wald1992sequential} proposed by Wald.

An important aspect of vaccine surveillance is continuous monitoring of adverse events that vaccinees may experience as vaccines are administered, through a continuous sequential analysis that detects a signal when adverse events exceed the probability that they occur by chance  \citep{kulldorff2011maximized}. Sequential Probability Ratio Test (SPRT) \citep{wald1992sequential} was proposed by Wald to detect adverse events through hypothesis testing. It is used to determine the most likely hypothesis among a set of hypotheses and is appropriate for sequentially independent and identically distributed (iid) data, which implies that the data comes from the same distribution. SPRT was then refined for vaccine surveillance, and we refer to this as Classical SPRT (cSPRT) in this paper. cSPRT is used for surveillance to test if the null hypothesis (no vaccine safety signal or the vaccine is safe), is more likely than the alternative hypothesis (there is a vaccine safety signal). However, cSPRT is highly sensitive to the relative risk chosen in the alternative hypothesis construction, which makes it difficult to use for ongoing, routine surveillance.

Consequently, \removed{Kulldorff et al.} \added{Silva et al.} proposed the use of a maximised sequential probability ratio test (MaxSPRT) \citep{kulldorff2011maximized} \added{cite silva's paper} based on a composite alternative hypothesis, which works across a range of relative risks. However, the various, specific objectives and data sources of vaccine surveillance groups have added to the complexity of implementing them using the different measures and parameters required for MaxSPRT analysis. \removed{This subsequently resulted in various implementations of MaxSPRT by other researchers in the community. }

\removed{To our knowledge, there is currently no literature describing the variations of MaxSPRT implementation, detailed and step-wise calculations, along with when to use them based on vaccine surveillance objectives, and data sources and types.} \added{May be some other motivations ... needed behind this paper ...}

\section{\changed{Methods}}\label{sec:methods}

\removed{This section describes the evolution of SPRT and MaxSPRT as reported in the literature} \added{Add something else to introduce the section: This section describes the evolution of continuous and sequential analysis}. It forms the foundation for the framework proposed in this paper for the implementation of MaxSPRT technique variations for vaccine safety.

\begin{figure*}[!htb]
    \centering
    \setlength{\belowcaptionskip}{0pt}
    \includegraphics[width=1\linewidth]{Variations_MaxSPRT.pdf}
    \caption{Different variations of MaxSPRT}
    \label{fig:variationMaxSPRT}
\end{figure*}

In both Waldâ€™s SPRT \removed{and cSPRT }\citep{wald1992sequential}, and \removed{Kulldorff's} \added{Silva's} MaxSPRT \citep{kulldorff2011maximized}, the number of adverse events is considered to be random, while the cumulative person-time or the cumulative number of vaccinations, if the follow-up time per vaccination is uniform, is considered to be fixed. The predicted number of adverse events under the null hypothesis is then considered to be a known function of the total person-time and certain possible confounding variables like age, sex, and location. 

\changed{Based on the dependence and sufficiency of the comparator data MaxSPRT can be divided into two groups, (i) Conditional MaxSPRT and (ii) unconditional MaxSPRT. THIS ONE NEED A LITTLE CHANGE AS PER LITERATURE. NOT FULLY WRONG.} When the background information is insufficient and conditional on an event, \removed{Kulldorff} \added{WRITE PROPER NAME I BELIEVE IT IS "LI"} developed conditional MaxSPRT (cMaxSPRT)~\citep{FDAMaxSPRT2021}, \changed{where it factors in the number of adverse events in the historical data and the surveillance population and computes the cumulative person-time it took to observe so many events as the random variable. CHANGE ACCORDINGLY ...}

\removed{The unconditional MaxSPRT can be further subdivided based on the properties of the dataset into two types} ~\citep{kulldorff2011maximized,FDAMaxSPRT2021,li2010conditional} \removed{: (i) pMaxSPRT for Poisson distribution data where values are real numbers, comparator data are not conditional on any event and sufficient background information is available; and (ii) bMaxSPRT for data with a binomial distribution where the SPRT analysis is conducted for each event being observed that is binary for each event.} \added{TOTALLY WRONG....}

\changed{The trend of variations continues for some further factors and parameters. These make the calculation of MaxSPRT quite challenging due to numerous variations. The parameters, hyperparameters, and conditions that need to be considered while calculating MaxSPRT are: } \added{KEEP THESE BUT REWORDING NEEDED SO THAT IT DONOT SAY VARIATIONS ...}
\begin{enumerate*}[label={(\roman*)}]
    \item the grouping of the reports based on age;
    \item the decision to use any comparator rate, sources of comparator rate, the process of calculating the comparator rate;
    \item the length of the risk window and the decision to slice or not slice risk windows;
    \item the decision to use the length of exposure, written as ``$l_{stiwa}$" in the figure (Figure~\ref{fig:variationMaxSPRT}) and later denoted as $l_{stiwa}$ in the rest of the paper, as a proxy to the calculation of exposed person time, and the variations in calculating the exposed person-time;
    \item the choice of using a test margin in the calculation; and
    \item the decision to use a delay adjustment, as well as the ways to calculate the delay adjustment.
\end{enumerate*}

\changed{Each combination of the aforementioned factors makes a different variation of MaxSPRT, therefore, the factors and hyperparameters are introduced briefly as follows and described in greater detail with relevant technical information below. THIS NEEDS REWARDING TOO ... WE COULD SAY THESE ARE THE HYPER-PARAMETER WE USED IN OUR IMPLEMENTATION AND DATA WRANGLING ...}

\begin{itemize}
    \item \textbf{Age grouping:} Sometimes, we can stratify the whole MaxSPRT analysis based on age groups. In such cases, all the calculations are performed at a more granular level, and all the hyperparameters, such as the historical comparator rate, are taken based on age grouping. For example, age strata can be 5-year or 10-year age groups, or bespoke grouping according to vaccine schedule. More small-ranged grouping can also be performed to address the risk of different AESIs for different age ranges. Moreover, unlike the static binning detailed above, a dynamic binning approach of risk and AEFI-based age grouping is also possible where all groups may not have the same interval. This could provide an option of sequential analysis. This kind of analysis has not been tried yet in the literature, to the best of our knowledge.
    \item \textbf{Comparator group:} One of the hyperparameters, which is also known as the historical comparator group. This is required as a reference value in calculating the likelihood of an event. This value sometimes needs scaling down based on the length of the observed period. There are several ways of calculating this rate, and the information available at the time of analysis also plays an important role. In the case where more than one option is available, the most relevant and reasonable one needs to be used. Two such potential options, as per~\citep{kulldorff2011maximized}, are:
        \begin{itemize}
            \item \textit{Retrospective rate of incidence:} This approach calculates the rate of incidence of the same AEFI in previous years. This rate can be calculated from the historical data, reflecting the ratio of reports in the previous years. 
            \item \textit{Treatment-seeking trend:} In this approach, the rate is calculated from General Practitioners' (GP) which is a term used in Australia that refers to primary care in general, clinics', and hospitals' data and health records by finding the trend of treatment-seeking behaviour for a particular AEFI.
        \end{itemize}
    \item \textbf{Risk-window slicing:} In MaxSPRT, while calculating various metrics, we can take the elapsed time of an observation period into consideration. This helps mitigate the gap of overestimating the risk or control period of a vaccine. It also allows slicing the risk window into smaller periods so that an observation period that is shorter than the risk window can scale down the required metrics as per the length of the observation period. In the sliced version, we further stratify the data, especially reports for different intervals of the risk window. This provides a more granular level of calculation and tuning. In~\citep{greene2011near}, authors show the efficacy of using a sliced risk window.
    \item \textbf{$l_{stiwa}$ calculation:} the measure required to estimate the expected number of events if the dose distribution information is unknown or insufficient.
        \begin{itemize}
            \item \textit{Exposed person-time:} The Centers for Disease Control and Prevention, USA (CDC) in~\citep{FDAMaxSPRT2021} proposed a technique and a formula to calculate the length of exposure in a person-time unit by capturing the trend of overlapping exposed time for the vaccinees within the risk window.
            \item \textit{Other alternative estimations:} If the CDC's approach can be replaced by some more reasonable approach that can capture the length of exposure more realistically and effectively.
        \end{itemize}
    \item \textbf{Test margin:} This is an optional hyperparameter that can be used to fine-tune the estimated expected number of events. For each AESI within each database, the test margins are defined based on comparator rates derived from historical data of the outcome, adjusted for the length of the risk window and a target number of doses required to cause harm. This specification aims to enhance the operating characteristics of the \changed{pMaxSPRT - NOT SURE IF CORRECT NAME IS USED} and improve the quality of information available for regulatory decision-making. To perform a one-sided test where the null hypothesis states that the rate of AESI in the vaccinated group is not higher than the historical comparator rate by a specific test margin ($m$), where $m$ is a non-negative value stated as a percent of the comparator rate.
    
    \changed{Hence, the choice of using it or not using it makes another fold of variations in MaxSPRT calculation and our implementation}, and of course, needs an assessment to determine which one is a better choice: using it or not using it. Moreover, in the case of using it, finding the optimal value of the test margin is also a challenge. 
    \item \textbf{Delay adjustment:} AESIs are not reported in real-time for various reasons. In sequential and continuous surveillance, this factor must be addressed in any version of MaxSPRT to adjust the observed number of events within the observation period. This adjustment to the observed number of events is required to help MaxSPRT find appropriate values for CVs to decide on the likelihood of signals in the study.
    
    There are several ways of calculating and adjusting the delay especially estimating the delay from retrospective analysis. Based on the availability of the data or reports in previous years for the same AEFI and for the same vaccines, we have divided the ways into two high-level classes.
        \begin{itemize}
            \item \textit{Historical $p(s, t)$:} If the analyser has access into the reports for the AEFI and the vaccine under consideration, then CDC's approach~\citep{FDAMaxSPRT2021} as explained in later sections (Section~\ref{subsec:pstCalculation}) can be followed to calculate $p(s, t)$ for dealing with delay adjustment.
            \item \textit{Concurrent $p(s, t)$:} Where the analyser does not have historical information on the trend of delays in reporting, such as in the case of a new AEFI or a new vaccine, the delay adjustment must be done by some predictive or approximation approach using the so far obtained concurrent data. We also explain this and propose a method to deal with this situation in Section~\ref{subsec:pstCalculation}.
        \end{itemize}
\end{itemize}

\section{\changed{Results}}\label{sec:results}
\changed{After analysing the relevant literature, we developed a taxonomy of variations of MaxSPRT as shown in Figure~\ref{fig:variationMaxSPRT}. ACTUALLY IT SHOULD BE SOMETHING LIKE ONE OF THE PAPER WHERE STEPS WERE WRITEN IN A TAXONOMICAL FORM.}

The structure and organisation of the taxonomy depict the factors that establish the \removed{SPRT subtypes and }implementation variations in a hierarchical manner. The variation starts with the availability of baseline information required to do the computation for surveillance. In some systems and situations, the expected number of events comes with associated uncertainty. There are various reasons behind the uncertainty that can add additional challenges to surveillance. To deal with uncertainty in the projected expected number of events, a conditional maximised sequential probability ratio test (cMaxSPRT)~\citep{li2010conditional} was proposed by Li et. al., with a known baseline risk function no longer needed. Instead, it considers the unpredictability that comes from both the surveillance population and historical data. \added{NOT ONLY UNPRDICTABILITY THEREE IS ANOTHER ISSUE IN THE BOTH POPULATION THAT'S WHY CMAXSPRT WAS PROPOSED . U CAN FIND IT IN CMAXSPRT PAPER}

To aid readability and implementation, we list the terminologies used in the literature to construct the narrative of the paper clearly. Table~\ref{table:notation} enlists the terms, their notations, and symbols that are commonly used throughout the paper. We refer to Appendix~\ref{sec:Terminology} for the definitions, examples, and explanations of the terms. \added{SHOUULD I ADD alpha, alpha spending function, Beta, statistical power, significance...}

\begin{table}[tb]
\caption{Notations}
\begin{adjustbox}{width=0.5\textwidth}
\begin{tabular}{|l||c|}
\hline
\multicolumn{1}{|c||}{\textbf{Terms}}              & \textbf{Notations} \\ \hline \hline
Study week                                      & $s$                  \\ \hline
Any week within the study period                  & $t$                  \\ \hline
Exposure weeks                                    & $w$                  \\ \hline
Time to onset                                     & $TTO$                \\ \hline
Slices in Risk window                             & $\delta$                  \\ \hline
Expected number of events                         & $\mu_s$                \\ \hline
Observed number of events                         & $Y_s$                  \\ \hline
Historical comparator rate                        & $\theta$              \\ \hline
Per day comparator incidence rate of age-group $a$ & $\theta_a$            \\ \hline
Proportion of data complete                       & $p(s, t)$            \\ \hline
Observed exposed person-time                      & $L_{stiwa}$             \\ \hline
Log-likelihood Ratio                              & $LLR$                \\ \hline
\end{tabular}
\end{adjustbox}
\label{table:notation}
\end{table}

\subsection{Properties of the Dataset}\label{subsec:DatasetProperties}
SAEFVIC (a Surveillance of Adverse Events Following Vaccination in the Community) data~\citep{clothier2017evaluation} is a set of timely passive surveillance data consisting of AEFI reports submitted by vaccinees, their relatives, GPs, nurses, or other healthcare professionals. It aligns to the minimum data for AEFI surveillance as per WHO~\citep{world2014global}. Each row of the data contains a report converted to a transactional database format, where each report is identified by a unique identifier named $Vaccinee\_ID$. Corresponding to each unique identifier, there are the age and sex information of the vaccinee, the time stamps of the dose administration, reporting time (when was it posted), and report submission. It also contains the time to onset expressed in the number of days for the adverse event, followed by the description of the event, reaction sign/symptom or clinical term of the event name, and vaccine brand, as well as the dose received. There are other data that are neither relevant nor required for MaxSPRT analysis, and we filtered them in the preprocessing step.

Like other real-world datasets, our data has missing values, too. This needs special attention before the data can be used for analysis. Data are collected through an online interactive form that is used by end-users (reporters). Hence, it is prone to errors like human errors that include misspellings and typographical errors. This implies that we need to use some mechanism to deal with unclean data.

Table~\ref{table:sampleDataDemonstration} shows the headers of a sample, a synthetic dataset developed from real-world data after altering it so that MaxSPRT analysis can detect a signal for demonstration purposes. We used this sample data for the analysis with selected columns, the corresponding data types, and the domains of the columns.

\begin{table*}[!htb]
\centering
\caption{SAEFVIC data set used in this paper with their attributes, types, and domains of the attributes, with pseudo sample data.}
\begin{adjustbox}{width=\textwidth}
\begin{tabular}{|l|c|c|c|c|c|c|c|c|c|}
\hline
\textbf{Attributes}                & \textbf{VacID}        & \textbf{Vaccine Name}                                                & \textbf{Age}                                                                   & \textbf{Sex}                                                       & \textbf{Time of Vaccination}                                                     & \textbf{TTO}                                                           & \textbf{Reporting Time}                                                      & \textbf{Submission Time}                                                           & \textbf{Reactions}                                                     \\ \hline
\textbf{Types}                     & String                & String                                                               & Number                                                                         & Binary                                                             & Time stamp                                                                   & Number                                                                 & Time Stamp                                                                   & Time Stamp                                                                         & String                                                                \\ \hline
\textbf{Domains}                   & Report ID             & Name                                                                 & Years                                                                          & M/F                                                                & \begin{tabular}[c]{@{}c@{}}Time\\ Format:\\ dd/mm/yyyy HH:MM:SS\end{tabular} & Days                                                                   & \begin{tabular}[c]{@{}c@{}}Time\\ Format:\\ dd/mm/yyyy HH:MM:SS\end{tabular} & \begin{tabular}[c]{@{}c@{}}Time\\ Format:\\ dd/mm/yyyy HH:MM:SS\end{tabular}       & \begin{tabular}[c]{@{}c@{}}Set of names\\ Comma Separated\end{tabular} \\ \hline
\textbf{Semantics}                 & Unique Identifier     & \begin{tabular}[c]{@{}c@{}}Name of the \\ vaccine brand\end{tabular} & \begin{tabular}[c]{@{}c@{}}Age of the\\ Vaccinee at\\ vaccination\end{tabular} & \begin{tabular}[c]{@{}c@{}}Gender\\ of the\\ Vaccinee\end{tabular} & \begin{tabular}[c]{@{}c@{}}Time of dose \\ administration\end{tabular}       & \begin{tabular}[c]{@{}c@{}}Time to\\ On setting\\ the AEFI\end{tabular} & \begin{tabular}[c]{@{}c@{}}When the AEFI \\ was reported\end{tabular}        & \begin{tabular}[c]{@{}c@{}}When the report was \\ recorded in SAEFVIC\end{tabular} & The Adverse Event                                                      \\ \hline
\end{tabular}
\end{adjustbox}
\label{table:sampleDataDemonstration}
\end{table*}

\subsection{Steps and processes of implementation}\label{subsec:StepsAndProcesses}
\changed{Here, we explain the step-by-step calculation of each measure, factor, and parameter required to calculate the $LLR$ (Log-likelihood Ratio), which is used to detect a signal in MaxSPRT analysis. Throughout the paper, we use a sample SAEFVIC dataset for a particular vaccine and "Abdominal pain" as an AEFI as a running example to demonstrate the calculations.}

Refer to Appendix~\ref{Implementation} (Implementation) for full details of each step, particularly during a MaxSPRT implementation in the SAEFVIC setting.

\subsubsection{Computing Cumulative Observed Number of events}\label{subsubsection:cumulativeObservedNumOfEvents}
We have taken all the reports into account after preprocessing (refer to Appendix~\ref{subsec:Preprocessing}, Preprocessing) the data. For each week $1 \leq t \leq s$, and each age group $a$, we counted the number of reports, say $Y_{(t, a)}$. Summing all the counts for all age groups for a particular week, $t$, gives the number of observed events for the week. We added a column $Y_{a}$ for each age group $a$'s report count and two more columns to the data, one for keeping track of the weekly observed report count $Y_{t}$ and the other one for keeping the cumulative counts of observed reports from week 1 up to a corresponding week $t$, $Y_{1, t}$.

As an illustration, Table~\ref{table:ObservedReportCount} shows the weekly count of observed events with a breakdown based on age strata. The last column shows the cumulative count of events. 


\begin{table*}[tbh]
\centering
\caption{Demonstration of computing observed report count for MaxSPRT analysis for Abdominal Pain}
\begin{adjustbox}{width=\textwidth}
\begin{tabular}{|ccccccccccc|c|}
\hline
\multicolumn{11}{|c|}{Computing Observed Report count for   MaxSPRT analysis for Abdominal Pain}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             &            \\ \hline
\multicolumn{1}{|c|}{\#Week} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Report count \\ of age 0-9\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Report count \\ of age 10-19\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Report count \\ of age 20-29\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Report count \\ of age 30-39\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Report count \\ of age 40-49\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Report count \\ of age 50-59\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Report count \\ of age 60-69\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Report count \\ of age 70-79\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Report count \\ of age 80+\end{tabular}} & \begin{tabular}[c]{@{}c@{}}Weekly \\ Total \\ Report\end{tabular} & \begin{tabular}[c]{@{}c@{}}Cumulative \\ Report \\ Count, $Y_{t}$\end{tabular} \\ \hline
\multicolumn{1}{|c|}{1}      & \multicolumn{1}{c|}{0}                                                                  & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{2}                                                                    & \multicolumn{1}{c|}{2}                                                                    & \multicolumn{1}{c|}{3}                                                                    & \multicolumn{1}{c|}{2}                                                                    & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{0}                                                                  & 9                                                                 & 9          \\ \hline
\multicolumn{1}{|c|}{2}       & \multicolumn{1}{c|}{0}                                                                  & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{4}                                                                    & \multicolumn{1}{c|}{2}                                                                    & \multicolumn{1}{c|}{3}                                                                    & \multicolumn{1}{c|}{3}                                                                    & \multicolumn{1}{c|}{2}                                                                    & \multicolumn{1}{c|}{1}                                                                    & \multicolumn{1}{c|}{0}                                                                  & 15                                                                & 24         \\ \hline
\multicolumn{1}{|c|}{3}       & \multicolumn{1}{c|}{0}                                                                  & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{7}                                                                   & \multicolumn{1}{c|}{12}                                                                   & \multicolumn{1}{c|}{7}                                                                   & \multicolumn{1}{c|}{3}                                                                    & \multicolumn{1}{c|}{2}                                                                    & \multicolumn{1}{c|}{1}                                                                    & \multicolumn{1}{c|}{1}                                                                  & 33                                                                & 57        \\ \hline
\multicolumn{1}{|c|}{4}       & \multicolumn{1}{c|}{0}                                                                  & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{8}                                                                    & \multicolumn{1}{c|}{13}                                                                   & \multicolumn{1}{c|}{11}                                                                   & \multicolumn{1}{c|}{8}                                                                    & \multicolumn{1}{c|}{5}                                                                    & \multicolumn{1}{c|}{5}                                                                    & \multicolumn{1}{c|}{1}                                                                  & 51                                                                & 168        \\ \hline
\multicolumn{1}{|c|}{5}       & \multicolumn{1}{c|}{0}                                                                  & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{17}                                                                   & \multicolumn{1}{c|}{16}                                                                   & \multicolumn{1}{c|}{18}                                                                   & \multicolumn{1}{c|}{14}                                                                   & \multicolumn{1}{c|}{7}                                                                    & \multicolumn{1}{c|}{5}                                                                    & \multicolumn{1}{c|}{1}                                                                  & 78                                                                & 246        \\ \hline
\multicolumn{1}{|c|}{6}       & \multicolumn{1}{c|}{0}                                                                  & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{1}                                                                    & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{4}                                                                    & \multicolumn{1}{c|}{6}                                                                    & \multicolumn{1}{c|}{6}                                                                    & \multicolumn{1}{c|}{2}                                                                  & 19                                                                & 265        \\ \hline
\multicolumn{1}{|c|}{7}       & \multicolumn{1}{c|}{0}                                                                  & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{2}                                                                    & \multicolumn{1}{c|}{1}                                                                    & \multicolumn{1}{c|}{7}                                                                    & \multicolumn{1}{c|}{6}                                                                    & \multicolumn{1}{c|}{7}                                                                    & \multicolumn{1}{c|}{1}                                                                  & 24                                                                & 289        \\ \hline
\multicolumn{1}{|c|}{8}       & \multicolumn{1}{c|}{0}                                                                  & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{1}                                                                    & \multicolumn{1}{c|}{1}                                                                    & \multicolumn{1}{c|}{1}                                                                    & \multicolumn{1}{c|}{10}                                                                   & \multicolumn{1}{c|}{14}                                                                   & \multicolumn{1}{c|}{3}                                                                    & \multicolumn{1}{c|}{1}                                                                  & 31                                                                & 320        \\ \hline
\multicolumn{1}{|c|}{9}       & \multicolumn{1}{c|}{0}                                                                  & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{1}                                                                    & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{20}                                                                   & \multicolumn{1}{c|}{18}                                                                   & \multicolumn{1}{c|}{2}                                                                    & \multicolumn{1}{c|}{0}                                                                  & 41                                                                & 361        \\ \hline
\multicolumn{1}{|c|}{10}     & \multicolumn{1}{c|}{0}                                                                  & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{1}                                                                    & \multicolumn{1}{c|}{4}                                                                    & \multicolumn{1}{c|}{1}                                                                    & \multicolumn{1}{c|}{2}                                                                    & \multicolumn{1}{c|}{0}                                                                  & 8                                                                 & 369        \\ \hline
\end{tabular}
\end{adjustbox}
\label{table:ObservedReportCount}
\end{table*}

\subsubsection{Length of exposure calculation}\label{subsubsection:lengthOfExposure}

The length of exposure is used to estimate the expected number of events in some \changed{variations of MaxSPRT analyses-NEED CHANGE}. This is roughly the cumulative count of exposed time per vaccinee after a dose is administered and until the reaction is set on them in the person-time unit. Definition~\ref{OexposedPersonTime} (Appendix~\ref{sec:Terminology}, Terminology) expresses a way of capturing the overall length of exposure for all vaccinee under consideration for a MaxSPRT analysis when dose administration information is not available at all, or at least not during the analysis in real-time.




\begin{table*}[tbh]
\centering
\caption{Demonstration of computing   $l_{stiwa}$ for MaxSPRT analysis for   Abdominal Pain}
\begin{adjustbox}{width=0.8\textwidth}
\begin{tabular}{|ccccccccccc|}
\hline
\multicolumn{11}{|c|}{Computing   $l_{stiwa}$ for MaxSPRT analysis for   Abdominal Pain}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \\ \hline
\multicolumn{1}{|c|}{\textbf{\#Week}}  & \multicolumn{1}{c|}{\textbf{\begin{tabular}[c]{@{}c@{}}$l_{stiwa}$\\ (0-9)\end{tabular}}} & \multicolumn{1}{c|}{\textbf{\begin{tabular}[c]{@{}c@{}}$l_{stiwa}$ \\ (10-19)\end{tabular}}} & \multicolumn{1}{c|}{\textbf{\begin{tabular}[c]{@{}c@{}}$l_{stiwa}$\\ (20-29)\end{tabular}}} & \multicolumn{1}{c|}{\textbf{\begin{tabular}[c]{@{}c@{}}$l_{stiwa}$\\ (30-39)\end{tabular}}} & \multicolumn{1}{c|}{\textbf{\begin{tabular}[c]{@{}c@{}}$l_{stiwa}$\\ (40-49)\end{tabular}}} & \multicolumn{1}{c|}{\textbf{\begin{tabular}[c]{@{}c@{}}$l_{stiwa}$\\ (50-59)\end{tabular}}} & \multicolumn{1}{c|}{\textbf{\begin{tabular}[c]{@{}c@{}}$l_{stiwa}$\\ (60-69)\end{tabular}}} & \multicolumn{1}{c|}{\textbf{\begin{tabular}[c]{@{}c@{}}$l_{stiwa}$\\ (70-79)\end{tabular}}} & \multicolumn{1}{c|}{\textbf{\begin{tabular}[c]{@{}c@{}}$l_{stiwa}$\\ (80+)\end{tabular}}} & \textbf{\begin{tabular}[c]{@{}c@{}}Weekly\\ $l_{stiwa}$\end{tabular}} \\ \hline
\multicolumn{1}{|c|}{1}                     & \multicolumn{1}{c|}{0}                                                                 & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{2}                                                                   & \multicolumn{1}{c|}{2}                                                                   & \multicolumn{1}{c|}{5}                                                                   & \multicolumn{1}{c|}{1}                                                                   & \multicolumn{1}{c|}{0}                                                                   & \multicolumn{1}{c|}{0}  & \multicolumn{1}{c|}{0}                                                                 & 10                                                                 \\ \hline
\multicolumn{1}{|c|}{2}                     & \multicolumn{1}{c|}{0}                                                                 & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{18}                                                                  & \multicolumn{1}{c|}{5}                                                                   & \multicolumn{1}{c|}{13}                                                                  & \multicolumn{1}{c|}{9}                                                                   & \multicolumn{1}{c|}{2}                                                                   & \multicolumn{1}{c|}{0}     & \multicolumn{1}{c|}{0}                                                              & 47                                                                 \\ \hline
\multicolumn{1}{|c|}{3}                  & \multicolumn{1}{c|}{0}                                                                 & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{24}                                                                  & \multicolumn{1}{c|}{18}                                                                  & \multicolumn{1}{c|}{37}                                                                  & \multicolumn{1}{c|}{10}                                                                  & \multicolumn{1}{c|}{8}                                                                   & \multicolumn{1}{c|}{4}      & \multicolumn{1}{c|}{3}                                                             & 104                                                                 \\ \hline
\multicolumn{1}{|c|}{4}               & \multicolumn{1}{c|}{0}                                                                 & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{51}                                                                  & \multicolumn{1}{c|}{57}                                                                  & \multicolumn{1}{c|}{51}                                                                  & \multicolumn{1}{c|}{38}                                                                  & \multicolumn{1}{c|}{14}                                                                  & \multicolumn{1}{c|}{28}      & \multicolumn{1}{c|}{15}                                                            & 254                                                                \\ \hline
\multicolumn{1}{|c|}{5}               & \multicolumn{1}{c|}{0}                                                                 & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{76}                                                                  & \multicolumn{1}{c|}{79}                                                                  & \multicolumn{1}{c|}{84}                                                                  & \multicolumn{1}{c|}{52}                                                                  & \multicolumn{1}{c|}{23}                                                                  & \multicolumn{1}{c|}{25}    & \multicolumn{1}{c|}{7}                                                              & 346                                                                 \\ \hline
\multicolumn{1}{|c|}{6}                & \multicolumn{1}{c|}{0}                                                                 & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{10}                                                                  & \multicolumn{1}{c|}{12}                                                                  & \multicolumn{1}{c|}{22}                                                                  & \multicolumn{1}{c|}{7}                                                                   & \multicolumn{1}{c|}{17}                                                                  & \multicolumn{1}{c|}{26}         & \multicolumn{1}{c|}{2}                                                         & 96                                                                 \\ \hline
\multicolumn{1}{|c|}{7}                & \multicolumn{1}{c|}{0}                                                                 & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{0}                                                                   & \multicolumn{1}{c|}{3}                                                                   & \multicolumn{1}{c|}{6}                                                                   & \multicolumn{1}{c|}{11}                                                                  & \multicolumn{1}{c|}{30}                                                                  & \multicolumn{1}{c|}{14}          & \multicolumn{1}{c|}{1}                                                        & 65                                                                 \\ \hline
\multicolumn{1}{|c|}{8}               & \multicolumn{1}{c|}{0}                                                                 & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{6}                                                                   & \multicolumn{1}{c|}{7}                                                                   & \multicolumn{1}{c|}{0}                                                                   & \multicolumn{1}{c|}{33}                                                                  & \multicolumn{1}{c|}{24}                                                                  & \multicolumn{1}{c|}{16}          & \multicolumn{1}{c|}{1}                                                        & 87                                                                 \\ \hline
\multicolumn{1}{|c|}{9}              & \multicolumn{1}{c|}{0}                                                                 & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{7}                                                                   & \multicolumn{1}{c|}{8}                                                                   & \multicolumn{1}{c|}{1}                                                                   & \multicolumn{1}{c|}{91}                                                                  & \multicolumn{1}{c|}{53}                                                                  & \multicolumn{1}{c|}{12}          & \multicolumn{1}{c|}{0}                                                        & 172                                                                 \\ \hline
\multicolumn{1}{|c|}{10}              & \multicolumn{1}{c|}{0}                                                                 & \multicolumn{1}{c|}{0}                                                                    & \multicolumn{1}{c|}{7}                                                                   & \multicolumn{1}{c|}{7}                                                                   & \multicolumn{1}{c|}{4}                                                                   & \multicolumn{1}{c|}{41}                                                                  & \multicolumn{1}{c|}{13}                                                                  & \multicolumn{1}{c|}{10}         & \multicolumn{1}{c|}{0}                                                         & 82                                                                 \\ \hline
\end{tabular}
\end{adjustbox}
\label{table:LstiwaCalculation}
\end{table*}

\subsubsection{Proportion of data complete calculation}\label{subsec:pstCalculation}

AEFIs are not reported in real-time for various reasons. Even after being reported, AEFI recording may also be delayed. This phenomenon is known as observation delay. Due to such delays, at the time of analysis, the amount of the observed data for a particular study week is likely to be less than the actual amount. This leads to an overestimation of the expected number of events, which imposes a potential risk of missing a signal. To address the issue, \changed{MaxSPRT has a feature of approximation - ITS NOT MAXSPRT ACTUALLY IT IS FOR PROPER CALCULATION OF EXPECTED COUNT} and this is known as calculating the proportion of data complete (the ratio of the observed and expected amount of data). We defined the term in Definition~\ref{defn:proportionDataComplete}.

As we discussed in Appendix~\ref{sec:Terminology}, CDC defined $p(s,t)$ in~\citep{FDAMaxSPRT2021}. However, the process of calculation or estimation of the term $p(i)$ was not clearly stated, and neither was it illustrated clearly in the paper. Although it looks quite straightforward to calculate this value from the ratios of reports obtained and expected, when we tried to apply the method we ended up with several possible ways of calculating the value. This adds more factors and hence variations of MaxSPRT calculation.

We also propose a new but similar way of calculating the proportion of data complete. We describe an equation to estimate the proportion of data complete that can be used to adjust the factor of delays in reporting incidents in Section~\ref{sec:CalculationOfDataComplete} using concurrent data. 

\subsubsection{Computing comparator rate, $\theta$}\label{subsubsection:theta}
There are several ways of calculating this rate, and two of the plausible ways are described in Appendix~\ref{sec:Terminology}. In our current implementation, we calculated this value retrospectively from the previous years' data~\citep{phillips2023background}. We have utilised our available data from previous years of the same reaction for calculating the background rates and used the formula mentioned in Definition~\ref{Defn:historicalComparatorRate} and Definition~\ref{Defn:perDayComparatorRate}. These background rates were extracted and analysed by our epidemiology team.

\begin{table*}[tb]
\centering
\caption{Demonstration of Reporting delay distribution \& computing $p(s, t)$ for Abdominal Pain}
\begin{adjustbox}{width=\textwidth}
\begin{tabular}{|cccccccccccc|}
\hline
\multicolumn{12}{|c|}{Reporting delay distribution   \& computing $p(s, t)$ for Abdominal Pain}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \\ \hline
\multicolumn{1}{|c|}{\begin{tabular}[c]{@{}c@{}}AEFI \\ Occuring \\ Week\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Reported on\\ Week 3\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Reported on\\ Week 4\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Reported on\\ Week 5\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Reported on\\ Week 6\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Reported on\\ Week 7\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Reported on\\ Week 8\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Reported on\\ Week 9\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Reported on\\ Week 10\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Reported after\\ Week 10\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Total \\ Reports\end{tabular}} & \begin{tabular}[c]{@{}c@{}}Total Reports   \\ up to \\ week s {[}s=10{]}\end{tabular} \\ \hline
\multicolumn{1}{|c|}{3}                                                                & \multicolumn{1}{c|}{1}                                                            & \multicolumn{1}{c|}{0}                                                            & \multicolumn{1}{c|}{2}                                                            & \multicolumn{1}{c|}{2}                                                            & \multicolumn{1}{c|}{1}                                                            & \multicolumn{1}{c|}{0}                                                            & \multicolumn{1}{c|}{0}                                                            & \multicolumn{1}{c|}{0}                                                             & \multicolumn{1}{c|}{0}                                                                & \multicolumn{1}{c|}{6}                                                        & 6                                                                                     \\ \hline
\multicolumn{1}{|c|}{4}                                                                & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{5}                                                            & \multicolumn{1}{c|}{10}                                                           & \multicolumn{1}{c|}{5}                                                            & \multicolumn{1}{c|}{2}                                                            & \multicolumn{1}{c|}{0}                                                            & \multicolumn{1}{c|}{1}                                                            & \multicolumn{1}{c|}{1}                                                             & \multicolumn{1}{c|}{1}                                                                & \multicolumn{1}{c|}{25}                                                       & 24                                                                                    \\ \hline
\multicolumn{1}{|c|}{5}                                                                & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{11}                                                           & \multicolumn{1}{c|}{33}                                                           & \multicolumn{1}{c|}{10}                                                           & \multicolumn{1}{c|}{2}                                                            & \multicolumn{1}{c|}{2}                                                            & \multicolumn{1}{c|}{0}                                                             & \multicolumn{1}{c|}{10}                                                               & \multicolumn{1}{c|}{68}                                                       & 58                                                                                    \\ \hline
\multicolumn{1}{|c|}{6}                                                                & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{23}                                                           & \multicolumn{1}{c|}{27}                                                           & \multicolumn{1}{c|}{9}                                                            & \multicolumn{1}{c|}{1}                                                            & \multicolumn{1}{c|}{2}                                                             & \multicolumn{1}{c|}{10}                                                               & \multicolumn{1}{c|}{72}                                                       & 62                                                                                    \\ \hline
\multicolumn{1}{|c|}{7}                                                                & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{31}                                                           & \multicolumn{1}{c|}{38}                                                           & \multicolumn{1}{c|}{9}                                                            & \multicolumn{1}{c|}{0}                                                             & \multicolumn{1}{c|}{10}                                                               & \multicolumn{1}{c|}{88}                                                       & 78                                                                                    \\ \hline
\multicolumn{1}{|c|}{8}                                                                & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{7}                                                            & \multicolumn{1}{c|}{10}                                                           & \multicolumn{1}{c|}{2}                                                             & \multicolumn{1}{c|}{2}                                                                & \multicolumn{1}{c|}{21}                                                       & 19                                                                                    \\ \hline
\multicolumn{1}{|c|}{9}                                                                & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{3}                                                            & \multicolumn{1}{c|}{6}                                                             & \multicolumn{1}{c|}{16}                                                               & \multicolumn{1}{c|}{25}                                                       & 9                                                                                     \\ \hline
\multicolumn{1}{|c|}{10}                                                               & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{}                                                             & \multicolumn{1}{c|}{9}                                                             & \multicolumn{1}{c|}{18}                                                               & \multicolumn{1}{c|}{27}                                                       & 9                                                                                     \\ \hline
\end{tabular}
\end{adjustbox}
\label{table:demonstrationOfDelayInReporting}
\end{table*}

\subsubsection{\removed{Test Margin, $M$}}\label{subsubsection:testMargin}
\changed{To the best of our knowledge, this is a value first used by CDC - IS IT A RIGHT CLAIM THAT THEY USED IT FOR THE FIRST TIME}~\citep{FDAMaxSPRT2021} for MaxSPRT analysis. It is particularly used to fine-tune the estimation of the expected number of events $\mu$ and used to emphasise a particular AEFI and vaccine/drug pair. Although, in our implementation, we facilitate specifying this value, by default we have used 1.0 for $M$. In particular, this can be a value close to 1 such as 1.01.

\subsubsection{Estimating the Expected number of events}\label{subsubsec:EstimateExpectNumOfEvens}

The expected number of events is the number of events expected to be observed without rejecting the null hypothesis. \removed{Calculating this number is not straightforward} \added{Calculating expected number of events WHICH IS ETS OR ESS is crucial and can be achieved in various ways}. It depends on the available information. There is a significant difference in calculating or estimating this value based on the available information. An approach to estimate this measure is proposed in~\citep{FDAMaxSPRT2021} and defined in Definition~\ref{defn:ApproximateExpCount} as ``Approximate Expected number of events'' in Appendix~\ref{sec:Terminology}. 

In passive surveillance or reporting systems, such as SAEFVIC, we do not have dose administration information in real time. In such systems, only the numerator, and the report count are available. Therefore, in this paper and in our current implementation, we focused on $l_{stiwa}$ (observed exposed person-time, see Appendix~\ref{sec:Terminology}, Terminology) based estimation of the denominator. Once all the required metrics for calculating the expected number of events ($\mu_{s}$) are found, we compute the expected count using Definition~\ref{defn:ApproximateExpCount} (Appendix~\ref{sec:Terminology}, Terminology). While processing the data, another column is added to it to keep the weekly cumulative expected number of event counts that is going to be utilised later to compute $LLR$. 

\subsubsection{Calculation of Data Complete}\label{sec:CalculationOfDataComplete}
We propose a new but similar way of calculating the proportion of data complete. We describe an equation to estimate the proportion of data complete that can be used to adjust the factor of delays in reporting incidents. We specified the way of calculating the ratio. The denominator of the ratio calculation is subject to the choice of dataset and timeline we choose. 

$$p(s,t) = \sum^{s}_{i=t}{p(i)}$$

where, $p(i)=\frac{c_{t}(i)}{c_{t}}$, and $c_{t}$ is the total number of reports for week $t$, $c_{t}(i)$ is the total number of reports for week $t$ at week $i$.

\changed{In several variations of MaxSPRT - NEED CHANGING}, using this factor is optional, such as in \citep{greene2011near}. In case we decide to use this factor, the calculation of the proportion of observed data can be performed in two ways. Firstly, similar to the existing works \citep{FDAMaxSPRT2021,greene2011near}, we can use historical data for the same AEFI and the same vaccine or a similar vaccine. Secondly, where no historical data is available, a special approach should be adopted to calculate the $p(i)$ using the concurrent data by estimating the proportion of later weeks of exposure from the earlier weeks of exposure.

In order to estimate the proportion of data complete from concurrent data, we can use the trend of delays in reporting for the weeks up to the study week. As an illustration of the reporting delay distribution, see Table~\ref{table:demonstrationOfDelayInReporting}. This distribution is for a MaxSPRT analysis on week 10 observed in an analysis performed to check for a safety signal for Abdominal pain. Note that the count of reports for each week with corresponding report submission weeks. The table contains the distribution of AEFI reporting with certain delays. As an example, it is expected that there will be 6 reports for week 3 and those were reported in weeks 3, 5, 6, and 7. Similarly, 25 reports of weeks 4, and 5 were reported in week 4, 10 on week 5, 5 on week 6, 2 on week 7, and 1 on each of week 9, 10, and after 10 weeks.

Refer to Appendix~\ref{variationsPST} to check the detailed calculation of the ratio to get $p(s, t)$. This metric is used in the MaxSPRT analysis and demo calculations.

\subsubsection{\changed{Demonstration of $l_{stiwa}$ calculation}}\label{demo_lstiwa}

In Table~\ref{table:lstiwaDemonstration}, we provide a visual demonstration of the calculation of $l_{stiwa}$ and how it is calculated for each person. As an example, vaccinee $V_{1}$ got a dose on the 1$^{st}$ day of week-1. Their $TTO$ was 5 days. Hence, the person was exposed from day 2 to day 6 of week-1. Hence, $l_{stiwa}$ of the person is denoted as $l_{sti(w=0)a}$ and calculated as 5. Also, vaccinee $V_{5}$ got a dose on the 5th day of week-1. Their $TTO$ was 11 days. Hence, the person was exposed from day 6 of week-1 to day 2 of week-3. Hence, the $l_{stiwa}$ of the person for weeks 1, 2, and 3 are denoted and calculated as $l_{sti(w=0)a}=2$, $l_{sti(w=1)a}=7$ and $l_{sti(w=2)a}=2$, respectively. At the end, the last row of the table shows the weekly $l_{stiwa}$.

Similar to the observed event count, we have added additional columns for $l_{stiwa}$ for each age group $a$, and for weekly $l_{stiwa}$ by adding all age-group based $l_{stiwa}$ for a particular week $t$. As an illustration, Table~\ref{table:LstiwaCalculation} shows the computed weekly $l_{stiwa}$ and age-strata based administration of $l_{stiwa}$. 


\subsubsection{\changed{Variations in $p(s, t)$ calculation}}\label{variationsPST}

To calculate the ratio for calculating $p(s, t)$, we need to know the total number of reports for the week. In the literature, this ratio is obtained from historical data. On the other hand, it is quite challenging to get the ratio \changed{in case the denominator is not known - WHAT DO YOU MEAN BY THIS. NEED POLISHING}. Estimating the ratio without a proper or exact denominator needs an approximation technique. 

One of the approximation techniques would be to take the total reports found so far as a denominator to compute the ratio. However, this technique would not be sufficient to approximate the ratio properly. Because, as shown in Table~\ref{table:demonstrationOfDelayInReporting}, it is quite possible that we have more information about earlier weeks and less information regarding later weeks. However, the ratio indicates a wrong proportion of data complete, that is, more for later weeks and less for earlier weeks, unlike a real scenario. In such cases, earlier week ratios will be more accurate than the later weeks. We can estimate the ratios of later weeks from the earlier weeks to deal with this challenge.

Our idea is to estimate a certain number of later weeks from the remaining weeks' $p(s,t)$. As an example, we can compute the last 50\% of weeksâ€™ $p(s,t)$ from all previous weeksâ€™ $p(s,t)$. There is scope to take lesser or greater than 50\%. We propose the following equation to calculate the proportion with a certain number of weeks' $p(s,t)$ to be estimated.

$$p(s,t)=\frac{1}{\lceil\frac{s}{d}\rceil} \sum^{\lceil\frac{s}{d}\rceil}_{w=1}{p(s, t-w)}$$

Here we estimate the $p(s,t)$ for week $t$ by taking the average of the $p(s,t')$ where $t'$ is the first half of the study weeks taking the division or partition number, $d$ = 2.  We can substitute this equation with some other more appropriate estimator, as well as we can tune the equation by changing the values of $d$. As an example, if $d=3$, the equation will take the average of the 1st one-third weeks' $p(s,t)$.

Table~\ref{table:DemonstrationOfDifferentPSTCalculations} shows the possible ways of calculating $p(s,t)$ for the delay distribution of the reports shown in Table~\ref{table:demonstrationOfDelayInReporting}. All five different approaches shown in the table for computing $p(s,t)$ do not comply with CDCâ€™s conclusions that the earlier weeks will have more data complete than the later weeks, but they also have different logic and merits. To choose the best and most effective one, further empirical assessment is required.

\subsubsection{Calculating $LLR$ and detecting signals}\label{subsubsection:calculateLLRDetectSignals}

\begin{table}[tbh]
\centering
\caption{Computing required parameter values for MaxSPRT analysis for Abdominal Pain using the formula in Definition~\ref{defn:ApproximateExpCount}}
\begin{adjustbox}{width=0.48\textwidth}
\begin{tabular}{|c|c|c|c|c|c|c|}
\hline
\#Week & $l_{stiwa}$ & $\Theta$                   & $l_{stiwa} \times \Theta$ & $p(s, t)$ & $\mu_{t}$  & Cumu. $\mu_{t}$ \\ \hline
1      & 10            & \multirow{10}{*}{0.235} & 2.35           & 0.9     & 2.12  & 2.12       \\ \cline{1-2} \cline{4-7} 
2      & 47            &                         & 11.05          & 1       & 11.05 & 13.17      \\ \cline{1-2} \cline{4-7} 
3      & 104           &                         & 24.44          & 0.95    & 23.22 & 36.39      \\ \cline{1-2} \cline{4-7} 
4      & 254           &                         & 59.69          & 0.93    & 55.51 & 91.9       \\ \cline{1-2} \cline{4-7} 
5      & 346           &                         & 81.31          & 0.93    & 75.62 & 167.52     \\ \cline{1-2} \cline{4-7} 
6      & 96            &                         & 22.56          & 0.9     & 20.30 & 187.82     \\ \cline{1-2} \cline{4-7} 
7      & 65            &                         & 15.28          & 0.75    & 11.46 & 199.28     \\ \cline{1-2} \cline{4-7} 
8      & 87            &                         & 20.45          & 0.89    & 18.20 & 217.48     \\ \cline{1-2} \cline{4-7} 
9      & 172           &                         & 40.42          & 0.75    & 30.32 & 247.8      \\ \cline{1-2} \cline{4-7} 
10     & 82            &                         & 19.27          & 0.25    & 4.82  & 252.6      \\ \hline
\end{tabular}
\end{adjustbox}
\label{table:ComputationOfDifferentParameterValuesOfMaxSPRT}
\end{table}

We used cumulative expected number of events, $\mu_{s}$ (a snapshot of calculation of all components/measures of $\mu$ is shown in Table~\ref{table:ComputationOfDifferentParameterValuesOfMaxSPRT}) and $Y_{s}$ up to week $s$, to calculate the $LLR$ using the formula in Definition~\ref{defn:llr}. Either, the $LLR$ or $Y_{s}$ is used to detect signals by comparing against the critical value, $CV$. Note, there are two types of critical values: (i) based on $LLR$ of the corresponding week's cumulative expected number of events, we denote it as $CV_{LLR_{\mu_{s}}}$ and (ii) based on $Y$, the corresponding week's observed event count, we denote it as $CV_{Y_{s}}$. In other words, say in week $t$, if $LLR_{t} \geq CV_{LLR_{\mu_{t}}}$ or $Y_{t} \geq CV_{Y_{t}}$, \changed{then there is a signal - REWORDING REQUIRED}.

\begin{table}[!htb]
\centering
\caption{Demonstration of signal detection through MaxSPRT analysis for Abdominal Pain (null hypothesis, $H_{0}$ = no signal and when $H_{0}$ is rejected, there is a signal)}
\begin{adjustbox}{width=0.5\textwidth}
\begin{tabular}{|c|c|c|c|c|c|c|c|c|c|}
\hline
Week\#, $t$ & Test\# & $\mu_{t}$   & $Y_{t}$ & Cumu. $\mu_{t}$ & Cumu. $Y_{t}$ & $RR_{t}$  & $LLR_{t}$  & $CV$  & Reject $H_{0}$? \\ \hline
1      & 1      & 2.12  & 9      & 2.12           & 9                 & 4.25        & 6.13 & 10  & No        \\ \hline
2      & 2      & 11.05 & 15     & 13.17          & 24                & 1.82        & 3.57 & 27  & No        \\ \hline
3      & 3      & 23.22 & 33     & 36.39          & 57                & 1.57        & 4.97 & 58  & No        \\ \hline
4      & 4      & 55.51 & 51     & 91.9           & 108               & 1.18        & 1.33 & 124 & No        \\ \hline
5      & 5      & 75.62 & 78     & 167.52         & 186               & 1.11        & 0.98 & 209 & No        \\ \hline
6      & 6      & 20.3  & 19     & 187.82         & 205               & 1.09        & 0.76 & 233 & No        \\ \hline
7      & 7      & 11.46 & 24     & 199.28         & 229               & 1.15        & 2.11 & 247 & No        \\ \hline
8      & 8      & 18.2  & 31     & 217.48         & 260               & 1.2         & 3.91 & 267 & No        \\ \hline
9      & 9      & 30.32 & 41     & 247.8          & 301               & 1.21        & 5.34 & 301 & Yes       \\ \hline
10     & 10     & 4.82  & 8      & 252.6          & 309               & 1.22        & NA   & NA  & NA        \\ \hline
\end{tabular}
\end{adjustbox}
\label{table:DemonstrationOfSignalDetection}
\end{table}

\begin{figure}[!htb]
    \centering
    \setlength{\belowcaptionskip}{0pt}
    \includegraphics[width=\linewidth]{MaxSPRT_RSequential_Paper.png}
    \caption{Visualising signal detection using MaxSPRT}
    \label{fig:MaxSPRTGraph}    
\end{figure}

At this stage, let's demonstrate the detection of the presence of any signal in a dataset. As shown in Table~\ref{table:DemonstrationOfSignalDetection}, the cumulative $Y_{t}$ and $LLR_{t}$ for study week, $t=9$ of the data is, respectively, 301 and 5.34 where $CV_{LLR_{\mu_{9}}} = 4.11$ for $\mu_{9} = 247.8$ (obtained from~\citep[Table 1]{kulldorff2011maximized} and not shown in Table~\ref{table:DemonstrationOfSignalDetection}) and $CV_{Y_{9}} = 301$ (obtained from Poisson MaxSPRT analysis using R Sequential package~\citep{rSequential} with a sample size = 500, total $\alpha = 0.05$ with 10 installments for 10 tests, each test having $\alpha = 0.005$, $\rho = 0.5$, the minimum number of events = 1). Hence, MaxSPRT indicates a signal in the week, $t=9$, with a 98\% likelihood that the vaccine is causing abdominal pain. \added{THIS WHOLE PART NEEDS CAREFUL CHECK AND CORRECTION OR EXPLANATION FOLLOWING THE LITERATURE, STANDARD AND THE REVIEW.}

Note in the above example, to perform MaxSPRT, especially using the Sequential package of R language, we need to provide some values as parameters: Sample size, Statistical significance ($\alpha$) and alpha spending plan, alpha spending function ($\rho$), statistical power, the minimum number of events, the observed number of events, and the expected number of events. Calculation of the expected number of events is highlighted in the paper. To aid the readers, we briefly introduced those terms in Appendix~\ref{MaxSPRTParams}.

\subsection{\added{MaxSPRT Parameters and use of Sequential Package}}\label{subsec:MaxSPRT_Param_Use_SeqPackage}
ADD CONTENTS ... ... ...

\subsection{\changed{Parameters for MaxSPRT analysis}}\label{MaxSPRTParams}
This section introduces some parameters required to perform MaxSPRT analysis for continuous surveillance using the Sequential package~\citep{rSequential}. Most of these parameters are explained in the manual~\citep{rSequential} with example scenarios and values. These parameters play a very important role in the analysis. 

\noindent
\changed{\textbf{Sample size:} - SHOULD IT BE EXPECTED SAMPLE SIZE?} A non-zero upper limit of the expected number of events under the null hypothesis is referred to as Sample size. This value is needed to early terminate the analysis when the observed number of events outnumbers this value under the null hypothesis (i.e., the null hypothesis is not rejected yet). There are various available methods in the package to estimate an optimised \changed{sample size - ESS} that reduces the estimated time to signal, as well as with different values of type-I error, relative risk, and statistical significance.\\

\noindent 
\changed{\textbf{TYPE I ERROR RATE SHOULD BE ADDED ? - Statistical significance level ($\alpha$) and alpha spending plan: ALSO NEED TO CHECK AS PER REVIEW AND STANDARD PRACTICE}} Statistical significance assesses whether the observed risk is not occurring due to random variation. The significance level $\alpha$ focuses on controlling Type-I errors and influences statistical significance in the analysis. MaxSPRT allows the defining or controlling of the alpha spending plan by the analyser. There are parameterisable methods to conduct an analysis using MaxSPRT where a specific plan to spend $\alpha$, such as, uniform in every analysis period, or conservative or generous at the beginning and changing exponentially or logarithmically in spending $\alpha$) can be executed. As per the plan, a certain amount of alpha will be spent in each analysis period (where period means weeks if the data is stratified into weeks and analysed weekly). $\rho$ is a positive number used for the power type alpha spending function.\\

\noindent
\changed{TYPE II ERROR RATE SHOULD BE ADDED? - \textbf{Statistical Power: ALSO NEED TO CHECK AS PER REVIEW AND STANDARD PRACTICE}} Statistical power measures the probability of identifying the risk if it is truly present. It focuses on controlling Type-II errors and is influenced by sample size and significance level.\\

\noindent
\textbf{Relative risk:} 
The relative risk $RR$ is the ratio of incidence rate in exposed and unexposed populations. In other words, this is the ratio of observed and expected rates of events. It is required that $RR > 1$, because, with $RR = 1$ means there is no difference between observed and expected incidences and hence no risk due to the vaccine. The higher the value of $RR$ the more the risk is, and the smaller will be the \changed{EXPECTED? sample size} if statistical significance and alpha remain constant. \\

\noindent
\textbf{Minimum number of events:} 
In vaccine safety surveillance, normally a minimum number of events need to be observed before rejecting the null hypothesis and marking the vaccine unsafe. This minimum number of events must be positive and \removed{should BE} \added{RECOMMENDED TO BE AT LEAST} 4~\citep{kulldorff2017continuous}. \\

\subsection{\changed{Challenges and Lessons Learnt}}\label{subsec:Challenges}
SPRT and MaxSPRT were introduced to conduct continuous and group sequential analysis that detects potential signals when adverse events exceed the probability that they occur by chance, and allows for continuous monitoring of adverse events that may occur in temporal association following immunisation. However,  Continuous surveillance for signal detection through MaxSPRT is challenging. The measure itself is quite complex and has been used and implemented in various ways. The challenges can be divided into three stages: 
\begin{enumerate*}
    \item pre-implementation,
    \item implementation, and
    \item post-implementation. 
\end{enumerate*}

Before we started the implementation of MaxSPRT, we faced a number of challenges. \changed{The first challenge was establishing a clear understanding of the procedure, terms, and underlying mathematics due to its many variations. -- NEED TO BE CAREFUL. The variations depend on the availability, nature, and properties of the data in hand. In addition, there is no hard and fast rule or specified model for the implementation  -- AS THE PROBLEM WAS NOT IN THE LITERATURE BUT CLEAR AND ILLUSTRATIVE ORGANIZATION BASED CHALLENGES TO WORK OR IMPLEMENT} Organisations have different capabilities and limitations that direct implementers towards different variations, as explained in Section~\ref{sec:introduction}.

\changed{The challenges we faced during implementation were mainly due to the lack of information in the literature - WRONG BUT THE WAY OF REPRODUCING IS NOT STRAIGHTFORWARD}. \changed{Most papers described the analysis process from a high level, with limited detailed information about the implementation. -- NEED CHANGE} Although some papers such as~\citep{FDAMaxSPRT2021,mesfin2019use} explain in more detail, they are not fully reproducible. As an example, the definition of $p(s,t)$ is insufficiently defined to reliably reproduce (as discussed in Section~\ref{subsec:pstCalculation}). The data source and technique to calculate the ``proportion of data complete" that captures and addresses the observation delay in reporting reactions add several variations in MaxSPRT, and dealing with the calculation of this term was challenging.

Calculating the expected number of events was the most onerous. Its significance in the whole surveillance process increases the difficulty because any significant mistake or error in the calculation of this term will mislead the surveillance. It has several components such as $p(s,t)$, $l_{stiwa}$, $\theta$ and each adds different variations \added{IN THE IMPLEMENTATION} (discussed in Section~\ref{sec:introduction} and Section~\ref{subsec:IncorporatingVariation}), especially when we do not have any prior information about the admissibility and correctness of the approaches and heuristics we have adopted.

Deciding whether to use age stratification or not, and if used, choosing between static grouping or dynamic binning technique adds to the challenge. Moreover, in the case of static grouping, deciding which grouping would give us optimal and more indicative results is not known and is subject to empirical analysis. In the case of either type of grouping, calculating the background rates for each age group also adds another layer of difficulty. 

Interestingly, the data source and technique to calculate the background rates add some variations and thus, additional challenges are introduced. Data properties and characteristics, such as the distribution of the data, also increase complexity in the implementation. One of the significant inherent challenges in any process involving data is missing values. In the case of MaxSPRT analysis, missing information in the data needs special consideration. We handled the missing data with great care, explained in Appendix~\ref{subsec:Preprocessing}.

We also had to deal with some challenges regarding the selection of the development and implementation tool and setting up the environment. We explained the issue in detail with our workaround in Appendix~\ref{subsec:SetupEnvironment}.

Moreover, it is also challenging to validate or assess if the implementation of MaxSPRT was correctly performed; to the best of our knowledge, there is no common and publicly available data to be used as a benchmark and standard outcome to compare the results due to the privacy, security, and ethics policies of the data used in the \changed{literature - OR DOMAIN}. Choosing and using the right version of \removed{MaxSPRT} \added{SEQUENTIAL ANALYSIS: GROUP OR CONTINUOUS, MAXSPRT POISSON OR BINOMIAL, CMAXSPRT? ALSO THE PARAMETER VALUES AS WELL AS RR, ALPHA SPENDING FUNCTION TYPE, TYPE I AND II ERROR RATES} adds to the complexity. To deal with all of these challenges, we implemented the framework in a way that allows the end user to exhibit different \changed{variations of MaxSPRT -- CAREFUL} for analysis using some arguments, and adjustment or changes to their values. We listed the available variations in Section~\ref{subsec:IncorporatingVariation}.

\begin{figure}[!htb]
    \centering
    % \setlength{\belowcaptionskip}{0pt}
    \includegraphics[width=\linewidth]{Flowchart_MaxSPRT.pdf}
    \caption{Flowchart of MaxSPRT}
    \label{fig:flowchartMaxSPRT}    
\end{figure}

\subsection{\removed{Incorporating variations}}\label{subsec:IncorporatingVariation}
MaxSPRT exhibits numerous variations that we explained in Section~\ref{sec:introduction}. In this section, we explain what variations are allowed in our current implementation. From the beginning, our focus was to make the implementation as flexible as possible so that the end user could utilise \changed{different variations of MaxSPRT -- CAREFUL} by tuning the values of the relevant parameters.

The main goal of this research was to provide support for vaccine safety analysis even in case sufficient baseline information is not handy. For this purpose, we follow the calculation of the expected number of events proposed by CDC~\citep{FDAMaxSPRT2021}. Their calculation of the expected number of events is termed in this paper as \changed{Approximate Expected Number of Events -- MAY BE STILL USE THE SAME NAME AS CDC? } as defined in Definition~\ref{defn:ApproximateExpCount} (Appendix~\ref{sec:Terminology}, Terminology). 
The equation in the definition takes into account several parameters, such as $l_{stiwa}$, $p(s, t)$, $\alpha$, and $M$. \changed{Each of these parameters introduces different variations of MaxSPRT -- WRONG}, as discussed in previous sections (such as Sections~\ref{sec:introduction} and Appendix~\ref{Implementation}), at least because of different approaches available and adapted by various research groups in their implementations of the parameters and MaxSPRT. \changed{Moreover, if we follow the approach of~\citep{greene2011near}, we can add more variations. - OKAY? } From our point of view, the following variations can be applied, and we provide the flexibility to use all the variations in our current implementation.

\begin{enumerate}
    \item\label{FDAop1} $\displaystyle \mu_{s}= 
\sum^{s}_{t=1} \sum^{n_{t}}_{i=1} \sum^{T_{i}}_{w=0} \sum^{A}_{a=1} {l_{stiwa} \times \theta_{a} \times P(s, t)}$
    \item\label{FDAop2} $\displaystyle \mu_{s}= 
\sum^{s}_{t=1} \sum^{n_{t}}_{i=1} \sum^{T_{i}}_{w=0} {l_{stiw} \times \theta \times P(s, t)}$
    \item\label{FDAop3} $\displaystyle \mu_{s}= 
\sum^{s}_{t=1} \sum^{n_{t}}_{i=1} \sum^{T_{i}}_{w=0} \sum^{A}_{a=1} {l_{stiwa} \times \theta_{a}}$
    \item\label{FDAop4} $\displaystyle \mu_{s}= 
\sum^{s}_{t=1} \sum^{n_{t}}_{i=1} \sum^{T_{i}}_{w=0} {l_{stiw} \times \theta}$
\end{enumerate}

\changed{Note that in Option~\ref{FDAop1}, we have not used the test margin, unlike CDC's original calculation~\citep{FDAMaxSPRT2021}. We can also vary the calculation by not using any age stratification for $\theta$ and thus for other parameters, as we did in Option~\ref{FDAop2} and Option~\ref{FDAop4}. We also omitted the use of $p(s, t)$ in Option~\ref{FDAop3} and Option~\ref{FDAop4}. More such variations could be introduced by taking the combination of all four parameters used in Definition~\ref{defn:ApproximateExpCount} (Appendix~\ref{sec:Terminology}, Terminology). -- REWRITING REQUIRED ...}

In our future work, we plan to investigate the performance of our MaxSPRT implementation and compare it with other statistical measures for vaccine safety surveillance. There, we plan to incorporate these variations in the performance analysis and describe our findings in detail following~\citep{greene2011near}.

\subsection{\changed{Flowchart}}\label{subsec:pseudo_codes}
Figure~\ref{fig:flowchartMaxSPRT}, shows a flow diagram of the MaxSPRT analysis. It describes the steps from taking input through to signal detection, including possible decision points to \changed{get a variation of MaxSPRT utilising the available information and selecting from possible options . Note that our current implementation is focused on the variations of MaxSPRT where baseline information is not known or insufficient - CAREFUL}. The diagram, however, shows a general flow of processes for most of the possible implementations and variations, including sufficient baseline information known. 

% This diagram also helps to identify the common segment of the two main variations. It also reveals that how and why they are different and how much they vary from each other. Moreover, the diagram shows how other variations are realised.

\section{\changed{Discussion}}\label{sec:discussion}
In the previous sections, we introduced \changed{the variations of MaxSPRT -- CHANGE}, the reasons and the factors behind the variations, the challenges associated with particular variations, and how to deal with them. We also explain how we implemented it with maximum flexibility to offer as many variations as possible while minimising editing to the underlying code. Our current implementation, however, does not include as yet all possible \changed{ variations of MaxSPRT -- CHANGE}, however, our Object-Oriented code can be easily extended with new variations, functionalities, and parameters without breaking any working code or module. This extensibility offers the opportunity to add new variations and devise more effective and adaptable signal detection.

Some additional potential variations that can be added are as follows: 

\begin{enumerate}
    \item Based on different ways of calculating the proportion of data complete, as shown in Table~\ref{table:demonstrationOfDelayInReporting}, there are five variations using the data available to us. More variations can be added based on the nature, characteristics, source, and purpose of the data. 
    \item Another prime source of variation in MaxSPRT is obtained through the proportion of data complete calculation based on the data source. Our options are using either concurrent data or historical data. We have added both in our current implementation.
    \item Based on the calculation of the length of exposure. Currently, we use observed exposed person time. This exposed person-time can be calculated in a different and perhaps more reasonable way that adds more effectiveness in the calculation of the length of exposure and thus the expected number of events.
    \item CDC has not used risk window slicing in~\citep{FDAMaxSPRT2021} but Greene et al. used risk window slicing in~\citep{greene2011near}. \changed{Hence, the risk window slicing can add another variation in MaxSPRT analysis to the conditional MaxSPRT. -- NEED CAREFUL REWRITING. FIRST, NOT CMAXSPRT. 2ND, WHEN CDC IS NOT USING, HOW USING IT HELPS MAKE VARIATIONS AND FACILITATE THE ANALYSIS.}
    \item A new thread to the variations can be weighted average of expected event counts calculated using the formulas used in Definitions~\ref{defn:ApproximateExpCount} (Appendix~\ref{sec:Terminology}, Terminology). This is only possible when baseline data is available. The efficacy of this idea needs extensive attention in terms of theoretical development and experimental analysis.
\end{enumerate}

\noindent
We also plan to extend our current implementation in various dimensions, such as applicability in surveillance and in other domains, to increase reusability, and enhance capability; towards wider accessibility, performance assessment and comparison, providing soundness in signal detection, and adaptability. We can extend our current implementation and the work on MaxSPRT in the following ways:

\begin{itemize}
    \item \textbf{Applicability in surveillance:} \added{SHOULD WE ADD THE REFERENCE THE ABSTRACT} Integrate MaxSPRT in a Bayesian Network (BN)~\citep{koller2009probabilistic,jensen2007bayesian} model that is being developed for signal detection within our organisation. Our plan is to build a BN model containing widely used statistical surveillance techniques as integrated nodes. Finally, the BN is expected to perform probabilistic inference~\citep{samiullah2023shareable,flores2004incremental} and find signals more effectively.
    \item \textbf{Performance benchmarking:} We plan to compare the performance of different variations of MaxSPRT and different statistical surveillance methods and techniques, such as proportional reporting ratio (PRR)~\citep{clothier2019early}, Empirical Bayes~\citep{harpaz2013empirical}, CUSUM~\citep{musonda2008monitoring},  for safety signal detection. This requires some standards of comparison, and our initial plan is to apply all the \changed{NEED CHANGE - variations of MaxSPRT} and all other statistical methods under consideration on the same data sample. We can then compare \changed{NEED CHANGE - MaxSPRT variations} in their capacity to detect signals under particular circumstances. Among the methods that can detect signals, we can rank them based on the time required to detect a signal. \changed{NEED TO CHANGE - We can also check if the generated signal is a false alarm or not, by checking the results among the methods. This develops another way of evaluating the capability of the methods in signal detection. We can then perform the analysis of effectiveness among the methods by calculating precision and recall.}
    \item \textbf{Providing wider accessibility:} Difficulties faced in MaxSPRT implementation can occur due to challenges associated with the range of potential variations; no definite answer to some critical issues; \changed{CHANGE - and a relative lack of established literature}. Another set of challenges  was the verification of the correctness and soundness of the implementation. This motivated us to write this paper and further plan to develop an Application Programming Interface (API) that can be used by researchers to detect signals using their data. Using an open-access API can also assist in verifying implementation by comparing implementation results with the output and scores generated by our API on the same data.    
    \item \textbf{Adaptability and extensibility:} \changed{WRONG -- Our current implementation is only for data with Poisson distribution.} The next step in our research is to integrate the facility to cope with the data having binomial distribution. \added{SAEFVIC AND BINOMIAL ARE QUITE DIFFERENT AS PLACEBO CONTROLLED ARE NOT AVAILABLE. BUT WE DID EXTENDED OUR IMPLEMENTAION FOR POLAR AND VSHL. }
\end{itemize}

\section{\changed{Conclusions}}\label{sec:conclusion}
MaxSPRT is a complex but powerful method for sequential \added{GROUP} and continuous surveillance. It provides flexibility for implementing in different situations and conducting surveillance with various data limitations. However, its flexibility comes with implementation and operational trade-offs. The associated challenges can make it difficult to implement in some contexts or organisations, which can prevent benefits from being realised.

In this paper, we explained the variations; factors behind the variations; parameters associated with different variations; potential ways of calculating parameters; challenges in calculating parameters; and consequences of using and not using various parameters. We also provided a step-by-step implementation description; demonstrating the corresponding output of each step. The step-by-step discussion also included a detailed description of our data, handling and pre-processing of the data, and our working environments.

This paper explained the MaxSPRT surveillance method in a new, different, clear, and intuitive way aiming to support its reproduction by providing mathematical and scientific notations and definitions of the relevant terms that mitigate the gaps between concept and reality. We included a flowchart of the overall implementation method for different \changed{variations of MaxSPRT}; and also added a hierarchy of the variations to demonstrate the evolution of the methods. 

Furthermore, we proposed new measures to assist in the calculation of some parameters. In case there are any special attributes or some missing attributes in our data, we showed in a detailed manner how to deal with the issues and proposed appropriate workarounds as a guideline for reproduction.

We discussed further \changed{CHANGE -- variations of MaxSPRT} that may better capture a signal and our plan to extend the work, aiming to provide greater support to the vaccine safety surveillance community and to the public health surveillance community more broadly. We intend to further the work with the empirical outcomes of the \changed{CHANGE -- variations of MaxSPRT} and other surveillance techniques.

Our paper provides a clear road map for future researchers and pharmacovigilance practitioners to implement MaxSPRT not only for vaccine safety surveillance but also for broader adverse drug event sequential analysis and safety monitoring.

\section*{Declarations}
\noindent
\textbf{Acknowledgement} We thank Professor Ann E Nicholson (ann.nicholson@monash.edu), Faculty of Information Technology, Monash University, Dr. Aishwarya Shetty (aishwarya.shetty@mcri.edu.au), Epidemiologist, Murdoch Children's Research Institute, and Dr. Ben Atkins (ben.atkins@mcri.edu.au), Statistical Data Analyst, Murdoch Children's Research Institute for their support, knowledge sharing, and providing various input from the beginning of the journey through to developing the framework and writing the paper. 

\noindent
\textbf{Funding} This research was part of a program of work enabled by a generous grant from the Royal Children's Hospital Foundation to the Centre for Health Analytics, Melbourne Children's Campus.\\

\noindent
\textbf{Conflicts of Interest/Competing Interests} None to mention.\\

\noindent
\textbf{Ethics Approval} This paper does not require ethics approval.\\

\noindent
\textbf{Consent to Participate} Not applicable.\\

\noindent
\textbf{Consent for Publication} Not applicable.\\

\noindent
\textbf{Availability of Data and Material} Not applicable.\\

\noindent
\textbf{Code Availability} Not applicable.\\

\noindent
\textbf{Authorsâ€™ Contributions} All authors contributed to the study conception. The frst draft of the manuscript was written by Samiullah, and all authors commented on previous versions of the manuscript. All authors read and approved the final manuscript.\\

\noindent
Funding acquisition: Buttery\\

\noindent
Investigation: Samiullah, Clothier, Yin, Munakabayo, Kattan, Mallard\\

\noindent
Methodology: Samiullah\\

\noindent
Project administration: Samiullah, Dimaguila\\

\noindent
Supervision: Clothier, Dimaguila, Buttery

% \bibliographystyle{spmpsci}
\bibliographystyle{spbasic}
\bibliography{ds-bibliography}% common bib file
%% if required, the content of .bbl file can be included here once bbl is generated
%%\input sn-article.bbl

\section*{Appendix}

\appendix
\section{Terminology}\label{sec:Terminology}

\begin{definition} \textbf{Study Week:} Let $s$ be the week at which the MaxSPRT analysis is being performed to find any potential signal for an AEFI on a particular dataset. This week, $s$,  is known as study week.
\end{definition}

\begin{definition} \textbf{Study period:} Let $s$ be the study week of surveillance through MaxSPRT analysis. The time between the beginning of an observation or surveillance and the study week $s$ is known as the study period, i.e., from the 1st week to week $s$, and denoted as [1: $s$]. \end{definition}

As an example, if an epidemiologist wants to perform a MaxSPRT signal detection analysis for fever post-influenza vaccination as an AEFI at week 10 of the observation period, then $s$=10. In this case, the study period is Week 1 to 10.

\begin{definition} \textbf{Intermediate week:}
Let $s$ be the study week of surveillance through MaxSPRT analysis. Any week, ranging from the start week (time/week of vaccine administration starts) up to the study week $s$, is called an intermediate week and denoted as $t$ where $1 \leq t \leq s$.
\end{definition}

For MaxSPRT analysis, we need to calculate several values in a weekly fashion, from week 1 of the observation week up to the observation/study week $s$. These weeks are known as intermediate weeks and are denoted by $t$. So, $t$=1, 2, ..., $s$.

\begin{definition} \textbf{Exposed weeks:} 
Let $s$ be the study week of a MaxSPRT analysis of a vaccine for an AEFI that has a risk window of length $RW$ days. Then, for any vaccinee who was administered a dose of the vaccine on week $t$ and having $TTO$ days of time-to-onset is in the exposed state for $min(TTO, RW)$ days starting from week $t$ just after the day of the dose administration. The weeks from $t$ to $t + \lceil min(TTO, RW)/7 \rceil$ are known as exposed weeks for the vaccinee and denoted as $w$.
\end{definition}

In other words, exposed weeks of a vaccinee are the weeks after a dose is administered to the person until the reaction/AEFI is observed on them.

As an example, if someone gets a dose on week-2 of the study period, and the risk window is 4 weeks or 28 days, then $2^{nd}$ week of the study period ($t$=2) is considered as the administered week and denoted as $w$=0 at week $t$ = 2, week $t$ = 3 is the 1st exposed week and denoted as $w$=1, and so on. This continues up to $w$=4 during week $t$=6 of the study period.

\begin{definition} \textbf{Time to onset:}
Let a vaccinee $V$ be administered a dose on day $d$ (calendar date $D$) of the week $t$ and a MaxSPRT analysis being performed in week $s$ where $t \leq s$. If the AEFI is observed on that vaccinee in day $d'$ (calendar date $D'$) of week $t'$ where $t \leq t' \leq s$, then the time required for the reaction to start/set is the difference between the two days $D$ and $D'$ is known as the time to onset and denoted as $TTO$ where $TTO = interval(D' - D)$.
\end{definition}

$TTO$ can be expressed in hours or in days in the SAEFVIC environment/system. As an example, if a vaccinee reported that on the 15th day after the dose the AEFI occurred, then $TTO$=15 days. This is rounded up to a day if $TTO$ is given in hours.

\begin{definition} \textbf{Risk Window:}
Let a vaccinee $V$ be administered a dose on day $d$ of the week $t$. Say, the AEFI is observed on that vaccinee on day $d'$ of week $t'$ where $t \leq t' \leq s$ and $TTO$ be the time-to-onset of the AEFI for the vaccinee $V$. The maximum value of ($TTO$, $RW$) for which the AEFI be considered as an effect of the vaccine is known as the Risk window and is denoted as $RW$.
\end{definition}

In other words, the Risk window is the maximum number of days/weeks a vaccinee is at risk of the AEFI after a dose. As examples, some AESIs with relevant risk windows are shown in the following Table~\ref{table:exampleAESIRiskWindow}.

\begin{table}[tbh]
\centering
\caption{Example of risk windows for potential AESIs~\citep{FDAMaxSPRT2021}}
\begin{adjustbox}{width=0.45\textwidth}
\begin{tabular}{|l|l|}
\hline
\multicolumn{1}{|c|}{\textbf{AEFI}}          & \multicolumn{1}{c|}{\textbf{Risk Window}} \\ \hline
Guillain-BarrÃ© syndrome                      & 1-42 days                                 \\ \hline
Bell's palsy                                 & 1-42 days                                 \\ \hline
Anaphylaxis                                  & 0-1 day                                   \\ \hline
Encephalomyelitis/Encephalitis               & 1-42 days                                 \\ \hline
Narcolepsy                                   & 1-42 days                                 \\ \hline
Appendicitis                                 & 1-42 days                                 \\ \hline
Non-hemorrhagic stroke                       & 1-28 days                                 \\ \hline
Hemorrhagic stroke                           & 1-28 days                                 \\ \hline
Acute myocardial infarction                  & 1-28 days                                 \\ \hline
Myocarditis/Pericarditis                     & 1-42 days                                 \\ \hline
Deep vein thrombosis (DVT)                   & 1-28 days                                 \\ \hline
Pulmonary embolism (PE)                     & 1-28 days                                 \\ \hline
Disseminated intravascular coagulation (DIC) & 1-28 days                                 \\ \hline
Immune thrombocytopenia (ITP)                & 1-42 days                                 \\ \hline
Transverse myelitis                          & 1-42 days                                 \\ \hline
Multisystem inflammatory syndrome            & 1-42 days                                 \\ \hline
\end{tabular}
\end{adjustbox}
\label{table:exampleAESIRiskWindow}
\end{table}

\changed{AFTER THE OBSERVED EXPOSED PERSON TIME, IT SEEMS LIKE THE IMPLEMENTATION VARIATION WE ARE WORKING IS NOT USING HISTORICAL INFO FOR CALCULATING EXPECTED COUNT AND USING LSTIWA IN PERSON TIME UNIT FROM CONCURRENT DATA AND NOT DIRECTLY RELATED DENOMINATOR AND JUST A BACKGROUND RATE THETA. HENCE THE OBSERVED EXPOSED ALSO BEING CALCULATED IN PERSON TIME. SO NEED TO DISCUSS THIS IN PLACED WHERE NEEDED TO EXPLAIN THE VARIATIONS AND THE ONE WE HAVE EXPLAINED HERE.}

\begin{definition}\label{OexposedPersonTime} \textbf{Observed exposed person-time:}
Let $s$ be the study week of a MaxSPRT analysis and a vaccinee $i$ of age group $a$ is administered a dose on week $t$ and $1 \leq t \leq s$. The number of days of a week $w$ ($t \leq t+w \leq s$) after vaccination and until the reaction/AEFI is set on the vaccinee is known as exposed person-time for the vaccinee $i$ in $w^{th}$ week and denoted as $l_{stiwa}$.
\end{definition}

It is required for calculating the expected number of events, $\mu_{s}$, and represents the length of exposed time for a vaccinee after a dose administration in a person-time unit.

Note, $l_{stiwa}$ has five terms incorporated in it, namely, $s$, $t$, $i$, $w$, and $a$ that corresponds to observation week $s$, dose week $t$, $i^{th}$ vaccinee, $w^{th}$ exposed week and $a$ age group in which the vaccinee $i$ belongs to. It is defined as the number of exposed days or length of exposure of a person $i$ of age group $a$ who got a dose on week $t$ where $t^{th}$ week is a week within the study week $s$. Note that for any vaccinee, $w=0$ means the week the vaccinee $i$ was administered a dose and $w=1$ means $1^{st}$ exposure week of the person.

$l_{stiwa}$ ranges from 0 to 7. If the dose is administered on the selected last day of a week $t$, $l_{stiwa}$ for the week $t$ will be 0 and denoted as $l_{sti(w=0)a} = 0$. More specifically, if the person was $7^{th}$ in the list of people reporting for that week of their AEFI and got the dose on the third week of the study period of 10 weeks, then the length of exposure for the first week of the person (or third week of the study for the person) is 0 and denoted as $l_{(s=10)(t=3)(i=7)(w=0)(a=50-59)} = 0$, where the person is categorised in the age range between 50 and 59. If the risk window of the AEFI is greater than or equal to 7 days, then for the same person the $l_{stiwa}$ for the next week is $l_{(s=10)(t=4)(i=7)(w=1)(a=50-59)} = 7$.

Say, for a risk window of 14 days, if the dose was administered on day 2 of a week, then $l_{sti(w=0)a} = 5$, $l_{sti(w=1)a} = 7$ and $l_{sti(w=2)a} = 2$. On the other hand, if the dose was administered on day 4 of a week, then $l_{sti(w=0)a} = 3$, $l_{sti(w=1)a} = 7$ and $l_{sti(w=2)a} = 4$.

\begin{definition}\label{defn:ApproximateExpCount} \textbf{Approximate Expected number of events:}
Following the definition of~\citep{FDAMaxSPRT2021},
let $s$ be the study week of a MaxSPRT analysis and $t$ be any intermediate week and $1 \leq t \leq s$. The approximate number of events that are to occur in a week $t$ under the null hypothesis, is known as the approximate expected number of events. It is denoted as $\mu''_{s}$ and defined as:

$$\mu''_{s}= 
\sum^{s}_{t=1} \sum^{n_{t}}_{i=1} \sum^{T_{i}}_{w=0} \sum^{A}_{a=1} {l_{stiwa} \times \theta_{a} \times P(s, t) \times M}
$$

where,
\begin{itemize}
    \item $s$ is a number representing the week when the signal detection analysis is being performed,
    \item $t$ is a number within [1, $s$] denoting any particular week from week 1 up to the study week,
    \item $n_{t}$ is the number of vaccinee got a dose on week $t$,
    \item $i$ is any particular individual or vaccinee,
    \item $T_{i}$ is the exposed weeks for vaccinee $i$ ranging from [1, $RW$],
    \item $RW$ is the risk window length, expressed in the number of weeks,
    \item $w$ is a value in the range [0, $T_{i}$] where $t+w$ represents a week under risk where $w = 0$ represents $t+0$ week of the surveillance which is the dose week of vaccinee $i$ and $w=1$ is the $t+1$ week in the study and 1st exposed week for the vaccinee,
    \item $A$ is the set of age group strata,
    \item $a$ is the strata of the vaccinee $i$,
    \item $l_{stiwa}$ is the observed exposed person-time, and
    \item $\theta_{a}$ is the per-day comparator rate of age group $a$.
    \item $M$ is the test margin.
\end{itemize}

\end{definition}

Let $RW$ be the risk window for the AEFI under consideration for MaxSPRT analysis. If the analysis being performed is in $\delta$ slices, then all the calculations for MaxSPRT are performed for each slice of the window. For some variations of MaxSPRT, we can split the risk window into several parts. Say, the risk window is 42 days, if $\delta$ = 6, then for each slice, the number of days = 7.

\begin{definition} \textbf{Expected number of events:}
Let $s$ be the study week of a MaxSPRT analysis and $t$ be any intermediate week and $1 \leq t \leq s$. The number of events that are likely to occur in week $t$ under the null hypothesis, is known as the expected number of events and denoted as $\mu_{s, t}$.
\end{definition}

It is one of the two parameters required to calculate $LLR$. Calculating $\mu_{s,t}$ is tricky and complicated. Estimating this value requires approximation in person-time. There are different approaches that can be adopted based on available data and information to estimate the value of $\mu_{s,t}$.

\begin{definition} \textbf{Observed number of events:}
The number of events that occurred under the risk window in week $t$ and reported as well as observed by week $s$, is known as the observed number of events and denoted as $Y_{s, t}$.
\end{definition}

This is another parameter for calculating $LLR$. It counts the weekly events within the risk window and is reported and observed by the study period.

\begin{definition}\label{Defn:historicalComparatorRate} \textbf{Historical comparator rate:}
Let a MaxSPRT analysis be performed for an AEFI due to a vaccine. Say, in previous $y$ years, $n$ people were observed to be affected by the AEFI out of $N$ people, then the historical comparator rate is defined as the ratio of the observed number of affected people by the AEFI, i.e., $\frac{n}{N \times y}$ and denoted as $\theta$.
\end{definition}

It is the value in person-time unit required to calculate the expected number of events, $\mu_{s}$, representing the number of people per year that suffer from an AEFI. It is calculated retrospectively from the previous years' data.

\begin{definition}\label{Defn:perDayComparatorRate} \textbf{Per-day comparator rate:}
Let $\theta$ be the historical comparator rate in previous $y$ years obtained by observing $n$ people to be affected by the AEFI out of $N$ people, then the per-day comparator rate is defined as the ratio of the observed number of affected people by the AEFI in a day, i.e., $\frac{n}{N \times y \times 365}$ and denoted as $\theta'$.
\end{definition}

In the case of age grouping stratified MaxSPRT analysis, the historical comparator rate and per-day comparator incidence rate may also vary. In order to address that, these rates for any age group $a$ are denoted as $\theta_{a}$ and $\theta'_{a}$, respectively. There are several ways of calculating the rate where two of the plausible ways are:
\begin{itemize}
    \item the rate of the AEFI within the general population
    \item healthcare-seeking behaviour for AEFI following vaccination
\end{itemize}

\begin{definition} \textbf{Observation delay:}
Let $s$ be the study week when a MaxSPRT analysis is being performed, $V = \{v_{1}, v_{2}, ..., v_{n}\}$ be the set of vaccinees reporting the AEFI, $T = \{t_{1}, t_{2}, ..., t_{n}\}$ and $T' = \{t'_{1}, t'_{2}, ..., t'_{n}\}$ be the set of corresponding AEFI observation weeks and AEFI reporting weeks of the vaccinees in $V$, respectively, where $1 \leq t_{i} \leq t'_{i}\leq s, 1 \leq i \leq n$. Then the time elapsed between the dose administration and AEFI reporting is known as observation delay and denoted as, $\displaystyle \delta = interval(T', T)$.

% $\delta(T', T) = | T'-T| = \forall_{i \in [1, n]} |t'_{i}-t_{i}|$.
\end{definition}

AESIs may not be promptly reported in real time due to various factors. Even when reported, there can be delays in recording AEFI cases, a phenomenon referred to as observation delay. These delays result in a reduced amount of observed data compared to the actual amount during analysis, potentially leading to an underestimation of expected event numbers and a risk of missing signals. To mitigate this issue, cMaxSPRT incorporates an approximation technique involving the calculation of the proportion of complete data (the ratio of observed to expected data). This concept is defined in the following Definition~\ref{defn:proportionDataComplete}.

\begin{definition}\label{defn:proportionDataComplete} \textbf{Proportion of data complete:}
Let $s$ be the study week when a MaxSPRT analysis is being performed and $\delta$ be the observation delay in the reports. Then, the proportion of data complete at week $s$ is the ratio of reports of week $1 \leq t \leq s$ that are available by week $s$ due to observational delay and total expected reports for week $t$. It is denoted as $p(s,t)$.
\end{definition}

As an example, at week $s$=10, we observe 6 reports of week $t$ = 5, and it is expected that 10 reports to be noted for week $t$ = 5. That means, only 60\% of week $t$=5 data or report is available. This is denoted as $p(10, 5)=0.6$.

There are several ways or heuristics to calculate this value. A retrospective analysis of historical data can be an option to compute this metric.

At the time of analysis, we may not obtain all the reports in time due to various reasons. Addressing this factor while estimating the expected number of events is crucial. Otherwise, we may overestimate the expected number of events. To address this issue and adjust the expected number of events, CDC \citep{FDAMaxSPRT2021} proposed the following equation.

$$p(s,t) = \sum^{s-t}_{i=0}{p(i)}$$

We explained the calculation techniques and challenges of this metric in the paper in Section~\ref{subsec:pstCalculation}.

\begin{definition} \textbf{Cumulative expected number of events:}
Let $s$ be the study week when a MaxSPRT analysis is being performed and $\mu_{s, t}$ be the expected number of events (reports) to occur in weeks $1 \leq t \leq s$. Then the cumulative expected number of events is denoted by $\mu_{s}$ and defined as:

$$\mu_{s} = \sum^{s}_{t=1}{\mu_{s, t}}$$
\end{definition}

\begin{definition} \textbf{Cumulative observed number of events:}
Let $s$ be the study week when a MaxSPRT analysis is being performed and $Y_{s, t}$ be the observed number of events (reports) occurring in weeks $1 \leq t \leq s$. Then the cumulative observed number of events is denoted by $Y_{s}$ and defined as:
$$Y_{s} = \sum^{s}_{t=1}{Y_{s, t}}$$
\end{definition}

It represents the number of AESIs occurring within the exposed risk window. It can be easily calculated by counting the cumulative sum of AEFI counts occurring weekly straightway. In order to find the number of observed events up to week $s$, we have to simply accumulate the number of events occurring weekly.

\begin{definition}\label{defn:llr} \textbf{Log-likelihood ratio:}
Let $s$ be the study week of a MaxSPRT analysis where $t$ be any intermediate week and hence $1 \leq t \leq s$. Also, let $\mu_{t}$ and $Y_{t}$ be the cumulative approximate expected number of events and cumulative observed number of events in the study, respectively, up to week $t$. Now, according to~\citep{kulldorff2011maximized}, the Log-likelihood ratio of week $t$ be denoted as $LLR_{t}$ and defined as follows:

\begin{align*}
LLR_{t} = 
\begin{cases} 
      \left(\mu_{t} - Y_{t}\right) + \mu_{t}log\left(\frac{Y_{t}}{\mu_{t}}\right) & Y_{t} \geq \mu_{t} \\
      0 & Y_{t} < \mu_{t}
   \end{cases}
\end{align*}
\end{definition}

\begin{definition} \textbf{Critical value:}
Let $s$ be the study week of a MaxSPRT analysis and $LLR_{t}$ be the Log-likelihood ratio for any intermediate week $1 \leq t \leq s$. According to~\citep{kulldorff2011maximized}, the value of $LLR_{t}$ (or $\mu_{t}$ if the analyser chooses this over $LLR_{t}$) that makes the alternative hypothesis true is defined as a critical value and denoted as $CV$.\added{NEED TO CHECK IF IT IS CORRECT.}
\end{definition}

There are two ways of detecting a signal \added{ALSO THIS IS INDICATED IN THE GRAPHS OF MAXSPRT AS PER ONE OF THE PAPER TOO WHERE TOP LEFT AND BOTTOM-RIGHT GRAPHS ARE USED TO SEE IF CV IS CROSSED IN LLR VALUE OR MAXSPRT VALUE}. Firstly, if the cumulative number of events observed at any time is beyond a prespecified number \added{IS IT AN EXPECTED NUMBER OR SOMETHING KNOWN IN THE LITERATURE ITH DIFFERENT NAME. I BELIEVE SO, FIND IT FROM THE RECENT PAPERS}, then there is no need to perform any MaxSPRT analysis \added{FURTHER AFTER THE NUMBER IS OBSERVED} and the null hypothesis can be rejected straightaway. Otherwise, at any week $t$, if the $LLR_{t}$ (or $\mu_{t}$) is beyond the corresponding critical value $CV$ expressed in likelihood (or, expressed in event count), then there is a signal, that is, $LLR_{t} \geq CV_{LLR_{t}}$, where $CV_{LLR_{t}}$ or $\mu_{t} \geq CV_{\mu_{t}}$, where $CV_{LLR_{t}}$ or $CV_{\mu_{t}}$ is the critical value for $\mu_{t}$ being the cumulative expected number of events for week $t$.

Kulldorff et. al. \citep{kulldorff2011maximized} proposed the technique, calculation, and uses of $CV$s for signal detection. They also developed an R sequential package with all functionality native to \changed{ACTUALLY SEQUENTIAL ANALYSIS -- MaxSPRT} calculation. If someone uses R, they do not need to reinvent the wheel for computing CV and other parameters required for MaxSPRT analysis. Moreover, in their paper they have given $CV$s for up to 1000 expected number of events, for the reason that if someone wants to use a $CV$ for signal detection, they do not need to compute $CV$s again.

In this paper, we offer a detailed explanation of the steps and challenges associated with the implementation of MaxSPRT on SAEFVIC's reporting database. SAEFVIC is the jurisdictional vaccine safety surveillance service of Victoria, Australia. Its AEFI and AESI reporting database~\citep{clothier2011surveillance} does not currently possess dose administration information. Dose administration data is collected from the Australian Immunisation Register. At the time of writing, SAEFVIC only had access to COVID-19 vaccines, in near real-time. Hence, the denominator of the MaxSPRT calculation - the expected number of events - requires estimation or conditioning to deal with its associated uncertainty. Therefore, in our implementation, we use the concept of cMaxSPRT, similar to the approach adopted by the US CDC \citep{FDAMaxSPRT2021} for surveillance of COVID-19 vaccine safety using insurance claim data. In both cases, the denominator is not known in real-time and at least not during the analysis. Being able to use a statistical method e.g. MaxSPRT in the absence of dose distributed denominator is therefore a practical advantage for spontaneous reporting systems to function as stand-alone signal detection systems.

\section{\changed{Data Processing and Environment Setup Implementation}}\label{Implementation}
In this section, we have explained the steps of implementation in a particular surveillance setting (in our case SAEFVIC).

\subsection{Preprocessing}\label{subsec:Preprocessing}

SAEFVIC data are prepared prior to processing. The pre-processing involves de-identification, noise handling, and missing data management. We have used the features of the MaxSPRT framework to deal with the pre-preprocessing challenges, especially, the missing data management. We allow analysers to opt-in methods to fill in missing values with some appropriate alternative values or simply discard the rows/records with missing values.

To justify filling in missing values, which is questionable from the point of view of epidemiology, this is logical from a data analysis perspective in certain scenarios. As an example, if we discard the records for some missing values in gender but the gender-specific stratification is not required in the calculation or analysis, then removing that record is not worthwhile. Rather, discarding the value adds bias to the numerator and denominator calculations. However, it is up to the user of the framework to decide whether to use the filling-in method or not.

We first de-identify the data to preserve the privacy of the reporters and vaccinees. In the framework, we allow for the de-identification of the data, which is quite straightforward, by removing all demographics and identifiable information about the vaccine and the reporter. The analyser can also mention if any further information needs to be removed for the de-identification other than the demographics. In the de-identification process, we assign a unique identifier to each report for record-keeping purposes. We keep the columns as specified in Table~\ref{table:sampleDataDemonstration}.

Next, we dealt with noisy data. We treat noisy data in a special manner by initially considering them as missing values. In this paper, noisy data are defined as values or inputs susceptible to error due to human and system error. First, we run a routine data cleaning for logic consistency, missing values, and filtering process, where any value that is beyond the range and domain of the corresponding data attribute is identified as noisy data. We first replaced a noisy value with missing values. Then treated them the same way as missing values.

In the third preprocessing step, we dealt with missing values. A common practice of dealing with missing values in data processing is to delete rows with noisy or missing values. However, in the case of vaccine safety surveillance, every report is important, so it is necessary to manage, instead of removing, missing records. We needed to carefully deal with missing records and use effective ways to fill them in. Of course, fill-in methods sometimes affect some important properties of the data such as mean, median, mode, standard deviation, and variance of the data. Therefore, the choice of the right fill-in method that has the least negative impact on the data is essential. Nevertheless, we leave it to the analyser to use fill-in, discard the record, or use any specific way of dealing with the missing and noisy data. In case, the analyser chooses to fill in missing values, then one of the following could be used: (i) default value/s, (ii) data-type specific alternative value, (iii) the analyser provided alternative values, or (iv) a method to get appropriate alternative values provided by the analyser. 

To the best of our knowledge, there is no best or single approach to dealing with missing values. Hence, in our framework, we allowed several methods to fill in missing values. An end user of the framework can opt into a specific method through parameterisation if they want to override the default one in their MaxSPRT analysis. Moreover, our data processing unit is capable of accepting new methods of filling in the missing values. The methods integrated into the current implementation that are used to fill in missing values in our data are actually the available methods in the Python Pandas package for fill-in such as ``replace'' with mean, median, mode, or some specific value like zero; and ``interpolate'' which also comes with a handful of options\footnote{Interested readers are recommended to see Pandas manual or \url{https://www.geeksforgeeks.org/working-with-missing-data-in-pandas/}.}.

To explain the preprocessing process on our data, the following steps are taken. As an example, for different columns, we have used different default fill-in methods for illustration purposes. For missing ``Age" and ``TTO'' values, we used linear interpolation as default. For ``Sex'' attribute, the missing values can be either replaced by randomly chosen value between ``M" and ``F" or as per the AESI we can decide if bias for a particular ``Sex'' is to be considered. By bias, we mean, some AESIs are more common or only for one sex (male or female) in comparison to the other. For treating missing values of ``Time to vaccine", ``Reporting time" and ``Submission time", we converted the times to double precision real numbers and then applied linear interpolation. However, this part is quite tricky and crucial, as these values will be used extensively in calculating most of the important terms in MaxSPRT. Also, there is an inherent order of the three values by definition, and the order is $Time$ $to$ $vaccine$ $\preceq$ $Reporting$ $time$ $\preceq$ $Submission$ $time$. Conducting the fill-in should not violate this order constraint. There is another constraint on ``Time to vaccine", ``Reporting time", and ``TTO" that is $Reporting$ $time$ $-$ $Time$ $to$ $vaccine$ $\leq TTO$. Therefore, the interpolation of ``Time to vaccine", ``Reporting time", and ``TTO" should satisfy this constraint as well.

We transformed the three timestamp values while dealing with missing values. In addition, we ran another iteration of data transformation on our data before we started processing them for analysis. The transformation includes a common and unique format of timestamps for all three timestamps we have used in our data, and $TTO$ values are rounded up to the nearest integer value.

To perform age-based and sex-based MaxSPRT analysis, we use age and sex columns. However, age-based analysis requires binning (or grouping or stratification of ages). We considered stratification as a preprocessing step. Here, we added a column to the data, ``Age-Strata" having nine different strata, namely 0--9, 10--19, 20--29, 30--39, 40--49, 50--59, 60--69, 70--79, 80+. This grouping can be done on more granular levels and also in a dynamic way rather than the static grouping as shown here. The alternative ways of age grouping also added variations to the analysis, as we mentioned before. Hence, we kept the scope to feed in new binning techniques as well as new or different age strata in our system.

Finally, we discarded the reports where $TTO$ is beyond the risk window, and this is an important step. Note that this is applicable if it is decided that the reactions that were observed after the specified and well-defined risk window are not considered in surveillance. 

As a pre-processing step of the data,  we assessed that the values/rates need to be scaled by the length of risk window.  This is because these values are computed in terms of person-time on a scale of 100,000 people per annum, and the risk windows are expressed in days. As an example, if the rate is 5.0 for 100,000 people-year and the risk window is 40 days long, scaling it down to $\frac{5 \times 40}{100000 \times 365}$ or $\frac{5 \times 40}{365}$ for 100k people is required to be used in MaxSPRT analysis.

Once the scaling is performed, we call them a per-day comparator to estimate the expected number of events. This is referred to as the expected rate of AEFI approximated for the currently vaccinated population which is not known, at least during the time of analysis.

We performed age-based stratification of the whole MaxSPRT analysis. Hence, this parameter offers another layer of computation where the rates vary for different age groups. In the case of no age-based stratification, we assumed a single and common rate for all age groups. This allows for facilitating the use of age groups and avoiding the age groups without any major reworking in the implementation, especially in the other modules of the implementation that are developed to allow age grouping in mind. Note that in cases of age grouping, all the calculations are performed at a more granular level and all the parameters used, including this one, are taken/calculated based on the age ranges of the groups. 

Interestingly, in the case of some parameters that are not available for age groups, we used the common and general values for all ages. In our current implementation, we have allowed both, adding age-based and general values for this parameter. However, for brevity and simplicity, this paper uses a single and general value for the parameter.

\begin{table*}[!htb]
\centering
\caption{Demonstration of $l_{stiwa}$ calculation and exposed person-time}
\begin{adjustbox}{width=\textwidth}
\begin{tabular}{|cc|ccccccc|ccccccc|ccccccc|}
\hline
% Demonstration of $l_{stiwa}$ calculation and exposed person-time

\multicolumn{1}{|c|}{\multirow{2}{*}{\textbf{VID}}}     & \multirow{2}{*}{\textbf{TTO}}    & \multicolumn{7}{c|}{\textbf{Week, t = 1}}                                                                                                                                                                                            & \multicolumn{7}{c|}{\textbf{Week, t = 2}}                                                                                                                                                                                            & \multicolumn{7}{c|}{\textbf{Week, t = 3}} \\                                                                                           
\cline{3-23}
% \hline
\multicolumn{1}{|c|}{}                                  &                                  & \multicolumn{1}{c|}{\textbf{Sat}} & \multicolumn{1}{c|}{\textbf{Sun}} & \multicolumn{1}{c|}{\textbf{Mon}} & \multicolumn{1}{c|}{\textbf{Tue}} & \multicolumn{1}{c|}{\textbf{Wed}} & \multicolumn{1}{c|}{\textbf{Thu}} & \textbf{Fri} & \multicolumn{1}{c|}{\textbf{Sat}} & \multicolumn{1}{c|}{\textbf{Sun}} & \multicolumn{1}{c|}{\textbf{Mon}} & \multicolumn{1}{c|}{\textbf{Tue}} & \multicolumn{1}{c|}{\textbf{Wed}} & \multicolumn{1}{c|}{\textbf{Thu}} & \textbf{Fri} & \multicolumn{1}{c|}{\textbf{Sat}} & \multicolumn{1}{c|}{\textbf{Sun}} & \multicolumn{1}{c|}{\textbf{Mon}} & \multicolumn{1}{c|}{\textbf{Tue}} & \multicolumn{1}{c|}{\textbf{Wed}} & \multicolumn{1}{c|}{\textbf{Thu}} & \textbf{Fri} \\ \hline
\multicolumn{1}{|c|}{\textbf{V1}}                       & 5                                & \multicolumn{1}{c|}{\begin{minipage}{0.04\textwidth}
      \includegraphics[width=\textwidth]{inject.png}
    \end{minipage}}   & \multicolumn{5}{c|}{\cellcolor{gray!25}$l_{sti(w=0)a}=5$}                                                                                                                                                             &              & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             &              & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             &              \\ \hline
\multicolumn{1}{|c|}{\textbf{V2}}                       & 4                                & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & {\begin{minipage}{0.04\textwidth}
      \includegraphics[width=\textwidth]{inject.png}
    \end{minipage}}   & \multicolumn{4}{c|}{\cellcolor{gray!25}$l_{sti(w=0)a}=4$}                                                                                                                         & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             &              & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             &              \\ \hline
\multicolumn{1}{|c|}{\textbf{V3}}                       & 12                               & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{\begin{minipage}{0.04\textwidth}
      \includegraphics[width=\textwidth]{inject.png}
    \end{minipage}}   &      \cellcolor{gray!25} $l=1$       & \multicolumn{7}{c|}{\cellcolor{gray!25}$l_{sti(w=1)a}=7$}                                                                                                                                                                                                                & \multicolumn{4}{c|}{\cellcolor{gray!25}$l_{sti(w=2)a}=4$}                                                                                                                         & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             &              \\ \hline
\multicolumn{1}{|c|}{\textbf{V4}}                       & 22                               & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{\begin{minipage}{0.04\textwidth}
      \includegraphics[width=\textwidth]{inject.png}
    \end{minipage}}   & \multicolumn{3}{c|}{\cellcolor{gray!25}$l_{sti(w=0)a}=3$}                                                                & \multicolumn{7}{c|}{\cellcolor{gray!25}$l_{sti(w=1)a}=7$}                                                                                                                                                                                                                & \multicolumn{4}{c|}{\cellcolor{gray!25}$l_{sti(w=2)a}=4$}                                                                                                                         & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             &              \\ \hline
\multicolumn{1}{|c|}{\textbf{V5}}                       & 11                               & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{\begin{minipage}{0.04\textwidth}
      \includegraphics[width=\textwidth]{inject.png}
    \end{minipage}}   & \multicolumn{2}{c|}{\cellcolor{gray!25}$l_{sti(w=0)a}=2$}                            & \multicolumn{7}{c|}{\cellcolor{gray!25}$l_{sti(w=1)a}=7$}                                                                                                                                                                                                                & \multicolumn{2}{c|}{\cellcolor{gray!25}$l_{sti(w=2)a}=2$}                                                 & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             &              \\ \hline
\multicolumn{1}{|c|}{\textbf{V6}}                       & 10                               & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             &              & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{\begin{minipage}{0.04\textwidth}
      \includegraphics[width=\textwidth]{inject.png}
    \end{minipage}}   & \multicolumn{4}{c|}{\cellcolor{gray!25}$l_{sti(w=0)a}=4$}                                                                                                    & \multicolumn{6}{c|}{\cellcolor{gray!25}$l_{sti(w=1)a}=6$}                                                                                                                                                                                                 &              \\ \hline
\multicolumn{1}{|c|}{\textbf{V7}}                       & 6                                & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             &              & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{\begin{minipage}{0.04\textwidth}
      \includegraphics[width=\textwidth]{inject.png}
    \end{minipage}}   &      \cellcolor{gray!25}  $l=1$      & \multicolumn{5}{c|}{\cellcolor{gray!25}$l_{sti(w=1)a}=5$}                                                                                                                                                             & \multicolumn{1}{c|}{}             &              \\ \hline
\multicolumn{1}{|c|}{\textbf{V8}}                       & 10                               & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             &              & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             &              & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{}             & \multicolumn{1}{c|}{\begin{minipage}{0.04\textwidth}
      \includegraphics[width=\textwidth]{inject.png}
    \end{minipage}}   & \multicolumn{4}{c|}{\cellcolor{gray!25}$l_{sti(w=0)a}=4$}                                                                                                    \\ \hline
\multicolumn{2}{|c|}{\textbf{\begin{tabular}[c]{@{}c@{}}Weekly Sum\\ $l_{stiwa}$\end{tabular}}} & \multicolumn{7}{c|}{11}                                                                                                                                                                                                                & \multicolumn{7}{c|}{30}                                                                                                                                                                                                                & \multicolumn{7}{c|}{25}                                                                                                                                                                                                                \\ \hline
\end{tabular}
\end{adjustbox}
\label{table:lstiwaDemonstration}
\end{table*}

\subsection{Processing of SAEFVIC Data}\label{furtherProcessingData}
%summary%
After the preprocessing of data, we started calculating the metrics that are required to perform MaxSPRT analysis and detect signals. The analysis is required to be performed in a well-defined frame of weeks for the sake of tracking the computation and facilitating weekly analysis. As a next step, we need a set of continuous windows in the analysis, where the data is divided into different windows of weeks based on their occurrence dates. Our implementation does not rely on any explicit length of the analysis or size of the data frame, or count of windows in the data frame. Moreover, our current implementation allows the analysers or epidemiologists to set their preferred start date, end date, length of analysis or count of windows in the frame.

In this task, the main challenge was to take the starting date of the first week. Then the formation of the windows was quite straightforward. The first window was formed by adding 7 days to the start date of the analysis. This gives us another date. Hence, our windows are defined by the start and end date of the week (does not matter what day of the week it is). Then, adding 1 to the last date of the first week gives us the first date of the second week. We make a set of windows each of 7 days or 1 week long by continuously following the steps. A point worth noting is that the start date of analysis is by default taken from the data by finding the earliest vaccination date. This can also be replaced by the earliest report date or report submission date. On the other hand, the frame ends with a week having an end date that is not later than six days from the latest date of reporting found in the data. Hence, our implementation does not rely on any explicit length of the analysis, the size of the data frame, or the count of windows in the data frame. Moreover, our current implementation allows analysts or epidemiologists to set their preferred start date, end date, length of analysis, or count of windows in the frame.

Finally, while computing various matrices like $p(s, t)$, $l_{stiwa}$, $Y$, $\mu$, and $LLR$, the data is further processed and new columns are added to it as required. We described this further processing and amendment of the columns to the data later, in Appendix~\ref{Implementation}.

\begin{table*}[!htb]
\centering
\caption{Demonstration of Different $p(s, t)$ Calculations}
\begin{adjustbox}{width=\textwidth}
\begin{tabular}{|cccccccccccc|}
\hline
\multicolumn{5}{|c|}{For s = 10}                                                                                                                                                                                                                                                                                                                                                                                & \multicolumn{4}{c|}{Using Historical Data}                                                                                                                                                                                                                                                                                                                                                                                                          & \multicolumn{3}{c|}{Using current data}                                                                                                                                                                                                                                                                                                           \\ \hline
\multicolumn{1}{|c|}{}      & \multicolumn{1}{c|}{}                                                                & \multicolumn{1}{c|}{}                                                                      & \multicolumn{1}{c|}{}                                                                              & \multicolumn{1}{c|}{}                                                                    & \multicolumn{2}{c|}{Idea 1}                                                                                                                                                                                                                            & \multicolumn{1}{c|}{Idea   2}                                                             & \multicolumn{1}{c|}{Idea   3}                                                                  & \multicolumn{2}{c|}{Idea   4}                                                                                                                                                                                                                           & Idea   5                                                                                \\ \hline
\multicolumn{1}{|c|}{t}     & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Expected\\ Count\\ (ER)\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Accumulated \\ Count \\ (AER)\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Observed count\\ (OR)\\ {[}up to S{]}\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Accumulated\\ count\\ (AOR)\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}p(i)\\ \\ {[}proportion of data\\ arriving at week i{]}\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}p(s, t)\\ \\ {[}sum of all p(i) \\ from current \\ to last week{]}\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}p(s, t)\\ \\ {[}AOR / AER{]}\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}p(s, t)\\ \\ {[}AER / Total ER{]}\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}p(i)\\ \\ {[}proportion of data \\ arriving at week i{]}\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}p(s, t)\\ \\ {[}sum of all p(i) \\ from current \\ to last week{]}\end{tabular}} & \begin{tabular}[c]{@{}c@{}}Hazel's $p(s, t)$ \\ \\ expectation: \\ OR/ER\\ (1.B)\end{tabular} \\ \hline
\multicolumn{1}{|c|}{3}     & \multicolumn{1}{c|}{6}                                                               & \multicolumn{1}{c|}{6}                                                                     & \multicolumn{1}{c|}{6}                                                                             & \multicolumn{1}{c|}{6}                                                                   & \multicolumn{1}{c|}{6/332 = 0.0181}                                                                                  & \multicolumn{1}{c|}{1}                                                                                                          & \multicolumn{1}{c|}{6/6 = 1}                                                              & \multicolumn{1}{c|}{6/332 = 0.02}                                                              & \multicolumn{1}{c|}{6/265 = 0.02}                                                                                     & \multicolumn{1}{c|}{1.00}                                                                                                       & 6/6 = 1                                                                                 \\ \hline
\multicolumn{1}{|c|}{4}     & \multicolumn{1}{c|}{25}                                                              & \multicolumn{1}{c|}{31}                                                                    & \multicolumn{1}{c|}{24}                                                                            & \multicolumn{1}{c|}{30}                                                                  & \multicolumn{1}{c|}{25/332 = 0.075}                                                                                  & \multicolumn{1}{c|}{0.98}                                                                                                       & \multicolumn{1}{c|}{30/31 =0.97}                                                          & \multicolumn{1}{c|}{31/332 = 0.09}                                                             & \multicolumn{1}{c|}{24/265 = 0.09}                                                                                    & \multicolumn{1}{c|}{0.98}                                                                                                       & 24/25 = 0.96                                                                            \\ \hline
\multicolumn{1}{|c|}{5}     & \multicolumn{1}{c|}{68}                                                              & \multicolumn{1}{c|}{99}                                                                    & \multicolumn{1}{c|}{58}                                                                            & \multicolumn{1}{c|}{88}                                                                  & \multicolumn{1}{c|}{68/332 = 0.205}                                                                                  & \multicolumn{1}{c|}{0.91}                                                                                                       & \multicolumn{1}{c|}{88/99 = 0.89}                                                         & \multicolumn{1}{c|}{99/332 = 0.30}                                                             & \multicolumn{1}{c|}{58/265 = 0.22}                                                                                    & \multicolumn{1}{c|}{0.89}                                                                                                       & 58/68 = 0.85                                                                            \\ \hline
\multicolumn{1}{|c|}{6}     & \multicolumn{1}{c|}{72}                                                              & \multicolumn{1}{c|}{171}                                                                   & \multicolumn{1}{c|}{62}                                                                            & \multicolumn{1}{c|}{150}                                                                 & \multicolumn{1}{c|}{72/332 = 0.217}                                                                                  & \multicolumn{1}{c|}{0.70}                                                                                                       & \multicolumn{1}{c|}{150/171 =0.88}                                                        & \multicolumn{1}{c|}{171/332 = 0.52}                                                            & \multicolumn{1}{c|}{62/265 = 0.23}                                                                                    & \multicolumn{1}{c|}{0.67}                                                                                                       & 62/72 = 0.86                                                                            \\ \hline
\multicolumn{1}{|c|}{7}     & \multicolumn{1}{c|}{88}                                                              & \multicolumn{1}{c|}{259}                                                                   & \multicolumn{1}{c|}{78}                                                                            & \multicolumn{1}{c|}{228}                                                                 & \multicolumn{1}{c|}{88/332 = 0.265}                                                                                  & \multicolumn{1}{c|}{0.49}                                                                                                       & \multicolumn{1}{c|}{228/259 = 0.88}                                                       & \multicolumn{1}{c|}{259/332 = 0.78}                                                            & \multicolumn{1}{c|}{78/265 = 0.29}                                                                                    & \multicolumn{1}{c|}{0.43}                                                                                                       & 78/88 = 0.89                                                                            \\ \hline
\multicolumn{1}{|c|}{8}     & \multicolumn{1}{c|}{21}                                                              & \multicolumn{1}{c|}{280}                                                                   & \multicolumn{1}{c|}{19}                                                                            & \multicolumn{1}{c|}{247}                                                                 & \multicolumn{1}{c|}{21/332 = 0.063}                                                                                  & \multicolumn{1}{c|}{0.22}                                                                                                       & \multicolumn{1}{c|}{247/280 = 0.88}                                                       & \multicolumn{1}{c|}{280/332 = 0.84}                                                            & \multicolumn{1}{c|}{19/265 = 0.07}                                                                                    & \multicolumn{1}{c|}{0.14}                                                                                                       & 19/21 = 0.91                                                                            \\ \hline
\multicolumn{1}{|c|}{9}     & \multicolumn{1}{c|}{25}                                                              & \multicolumn{1}{c|}{305}                                                                   & \multicolumn{1}{c|}{9}                                                                             & \multicolumn{1}{c|}{256}                                                                 & \multicolumn{1}{c|}{25/332 = 0.075}                                                                                  & \multicolumn{1}{c|}{0.16}                                                                                                       & \multicolumn{1}{c|}{256/305 = 0.84}                                                       & \multicolumn{1}{c|}{305/332 = 0.92}                                                            & \multicolumn{1}{c|}{9/265 = 0.03}                                                                                     & \multicolumn{1}{c|}{0.07}                                                                                                       & 9/25 = 0.36                                                                             \\ \hline
\multicolumn{1}{|c|}{10}    & \multicolumn{1}{c|}{27}                                                              & \multicolumn{1}{c|}{332}                                                                   & \multicolumn{1}{c|}{9}                                                                             & \multicolumn{1}{c|}{265}                                                                 & \multicolumn{1}{c|}{27/332 = 0.081}                                                                                  & \multicolumn{1}{c|}{0.08}                                                                                                       & \multicolumn{1}{c|}{265/332 = 0.8}                                                        & \multicolumn{1}{c|}{332/332 = 1.00}                                                            & \multicolumn{1}{c|}{9/265 = 0.03}                                                                                     & \multicolumn{1}{c|}{0.03}                                                                                                       & 9/27 = 0.33                                                                             \\ \hline
\multicolumn{1}{|c|}{Total} & \multicolumn{1}{c|}{332}                                                             & \multicolumn{1}{c|}{}                                                                      & \multicolumn{1}{c|}{265}                                                                           & \multicolumn{8}{c|}{}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              \\ \hline
\end{tabular}
\end{adjustbox}
\label{table:DemonstrationOfDifferentPSTCalculations}
\end{table*}

% \appendix{C}
\subsection{Environment Setup and tools}\label{subsec:SetupEnvironment}
Kulldorff et al~\citep{FDAMaxSPRT2021} and Greene et al~\citep{greene2011near} \added{ALSO SILVA} recommended the use of R programming language as there is a package called ``Sequential" in $R$ developed especially for sequential analysis and contains all the required functionalities for MaxSPRT and other similar continuous and sequential analyses. \changed{NOT FULLY TRUE THOUGH, RATHER R SEQUENTIAL IS NOT FOR DATA WRANGLING YOU COULD CLARIFY THIS -- However, our review of the literature and domain reveals that the main dependency of MaxSPRT implementation on R is to calculate critical values, $CV$ for corresponding $\mu$ with a proper $\alpha$ spending plan}~\citep{silva2019alpha}. \changed{ADD HERE HOW TYPE I AND II ERROR RATE/PROBABILITY, ALPHA SPENDING PLAN/FUNCTION/SHAPE, ESS AND ETT AND ALSO SURVEILLANCE LENGTH AND STATISTICAL POWER AND SIGNIFICANCE ARE DEALT IN THE PACKAGE -- This $\alpha$ spending plan will tune the threshold of $\alpha$ value automatically based on the situation to detect a signal as soon as possible with as minimum type-1 error as possible.} However, Kulldorff et al \added{NOT ONLY KULDORF, ALSO OTHER PEOPLE LIKEL LI ADDED SUCH VALUES FOR CMAXSPRT, SILVA DID FOR ALPHA SPENDING ... ETC ALSO NOT SURE IF KULDORF OR SILVA SHOULD BE THE NAME THAT I USED IN THE FIRST SUBMISSION} describes in ~\citep{kulldorff2011maximized} that if someone wants to use the table of $CV$s for a specific $\alpha$ (note, the table contains $CV$ for three different values of $\alpha$, namely, 0.01, 0.05, and 0.1) and for $\mu$ of up to 1000, they do not need to regenerate the $CV$s. 

We have used Python and various packages (e.g.,  Panda) of Python that facilitate easy data handling and extensibility. For better error handling, extensibility, and code reuse; and to follow software engineering best practice and principles, we adopted the Object-Oriented Programming style. This allows new methods to be injected easily into the implementation. As an example, ``R" codes can be easily integrated by embedding into the Python code segment. Hence, the ``R" sequential package and other required ``R" codes to deal with $CV$ calculation and $\alpha$ spending plan can be added \added{NOT CAN BE ADDED, ACTUALLY ADDED} as an embedded module in the python implementation of MaxSPRT. We have integrated the ``R''-scripting facility and embedded the ``Sequential'' package in our current implementation to provide maximum facility to the analysers.

Our choice of Object-oriented programming style also helps in implementing the different variations of \changed{CAREFUL -- MaxSPRT} by adding more than one method for the same measure/metric like $P(s,t)$, $\theta$, and $l_{stiwa}$. Therefore, in the later stage especially during MaxSPRT analysis different variations of MaxSPRT can be designed by just choosing parameter values and more variations can be added without breaking any working and existing code/module.





\section{\added{Implementation and code repository}}\label{Implementation_Code_Repo}


\end{document}