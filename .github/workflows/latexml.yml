name: Build HTML with LaTeXML and inject icons

on:
  push:
    branches: [ main ]    # change if your default branch is different

permissions:
  contents: write        # required to push changes back

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0          # ensure full history for commits
          persist-credentials: true  # allow authenticated git push using GITHUB_TOKEN

      - name: Show repo files (debug)
        run: |
          echo "CWD: $(pwd)"
          ls -la

      - name: Install LaTeXML and utilities
        run: |
          sudo apt-get update -y
          sudo apt-get install -y latexml perl git
          # ensure perl exists (it does on ubuntu images), but we include it for clarity

      - name: Build with LaTeXML (LaTeX -> XML -> HTML5)
        run: |
          # Adjust main.tex below if your main file has a different name
          if [ ! -f main.tex ]; then
            echo "ERROR: main.tex not found in repo root. Listing files:"; ls -la; exit 2
          fi
          mkdir -p build
          latexml --dest=build/main.xml main.tex
          latexmlpost --format=html5 --dest=build/index.html build/main.xml

      - name: Prepare docs/ for GitHub Pages
        run: |
          rm -rf docs || true
          mkdir -p docs
          cp -r build/* docs/

      - name: Inject Font Awesome CDN and replace icon markers
        run: |
          # Use a simple CDN include (no integrity attribute)
          FA_LINK='<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>'
          # Insert FA link before </head> if not already present
          if ! grep -q "cdnjs.cloudflare.com/ajax/libs/font-awesome" docs/index.html; then
            perl -0777 -pe 's{</head>}{'"$FA_LINK"'\n</head>}i' -i docs/index.html || true
          fi

          # Replace marker tokens with spans
          perl -pi -e 's/ICON-SYRINGE/<span class="icon-syringe"><\/span>/g' docs/index.html
          perl -pi -e 's/ICON-AMBULANCE/<span class="icon-ambulance"><\/span>/g' docs/index.html

          # Remove possible byte-order-mark
          perl -pi -e 's/\x{FEFF}//g' docs/index.html || true

      - name: Add a tiny CSS file for icon mapping
        run: |
          cat > docs/icons.css <<'EOF'
          /* map inserted span markers to FontAwesome glyphs */
          .icon-syringe::before { font-family: "Font Awesome 6 Free"; font-weight: 900; content: "\f48e"; } /* fa-syringe */
          .icon-ambulance::before { font-family: "Font Awesome 6 Free"; font-weight: 900; content: "\f0f9"; } /* fa-ambulance */
          .icon-syringe::before, .icon-ambulance::before { margin-right: 0.2em; }
          EOF

          # Add icons.css include if not present
          if ! grep -q "icons.css" docs/index.html; then
            perl -0777 -pe 's{</head>}{<link rel="stylesheet" href="icons.css" />\n</head>}i' -i docs/index.html || true
          fi

      - name: Commit generated docs/ and push (authenticated)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add docs || true

          # Only commit if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Build HTML output (LaTeXML) and inject icons"
            # push using the credential persisted by actions/checkout
            git push origin HEAD:main
          fi
